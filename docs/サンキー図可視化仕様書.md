# RS2024 サンキー図可視化仕様書

## 概要

予算と支出の流れを4階層のサンキー図で可視化する。
左側（予算ベースの世界）と右側（支出ベースの世界）を明確に分離し、各事業における予算額と支出額の差を可視化する。

## データフロー

```
[予算ベースの世界]                    [支出ベースの世界]

府省庁(予算) → 事業(予算) → 事業(支出) → 支出先
   列1            列2           列3         列4
```

### 4列構成:

1. **列1: 府省庁（予算）**
   - 府省庁ごとの総予算額
   - Top3を予算額順に選択

2. **列2: 事業（予算）**
   - 各事業の予算額
   - 各府省庁内でTop3を予算額順に選択

3. **列3: 事業（支出）**
   - 各事業の支出額
   - 列2と同じ事業だが、金額は支出額
   - 予算額との差を可視化

4. **列4: 支出先**
   - 支出先ごとの受領額
   - 各事業（支出）からTop3を支出額順に選択

## ノード構造

### 列1: 府省庁ノード（予算）
```typescript
{
  id: "ministry-budget-{ministryId}",
  name: "{府省庁名}（予算）",
  type: "ministry-budget",
  value: {府省庁の総予算額},
  originalId: {ministryId}
}
```

### 列2: 事業ノード（予算）
```typescript
{
  id: "project-budget-{projectId}",
  name: "{事業名}（予算）",
  type: "project-budget",
  value: {事業の予算額},
  originalId: {projectId}
}
```

### 列3: 事業ノード（支出）
```typescript
{
  id: "project-spending-{projectId}",
  name: "{事業名}（支出）",
  type: "project-spending",
  value: {事業の支出額},
  originalId: {projectId}
}
```

### 列4: 支出先ノード
```typescript
{
  id: "recipient-{spendingId}",
  name: "{支出先名}",
  type: "recipient",
  value: {支出先の受領額},
  originalId: {spendingId}
}
```

## リンク構造

### リンク1: 府省庁（予算） → 事業（予算）
```typescript
{
  source: "ministry-budget-{ministryId}",
  target: "project-budget-{projectId}",
  value: {事業の予算額}
}
```

### リンク2: 事業（予算） → 事業（支出）
```typescript
{
  source: "project-budget-{projectId}",
  target: "project-spending-{projectId}",
  value: min({予算額}, {支出額})
}
```
※ このリンクで予算と支出の差が視覚的に見える

### リンク3: 事業（支出） → 支出先
```typescript
{
  source: "project-spending-{projectId}",
  target: "recipient-{spendingId}",
  value: {この事業からの支出額}
}
```

## 選択アルゴリズム（再帰的Top3）

### ステップ1: Top3府省庁を選択（予算額順）
```typescript
const topMinistries = data.budgetTree.ministries
  .sort((a, b) => b.totalBudget - a.totalBudget)
  .slice(0, 3);
```

### ステップ2: 各府省庁内でTop3事業を選択（予算額順）
```typescript
for (const ministry of topMinistries) {
  const ministryProjects = data.budgets
    .filter(p => p.ministry === ministry.name)
    .sort((a, b) => b.totalBudget - a.totalBudget)
    .slice(0, 3);

  topProjects.push(...ministryProjects);
}
// 結果: 3府省庁 × 3事業 = 9事業
```

### ステップ3: 各事業内でTop3支出先を選択（支出額順）
```typescript
for (const project of topProjects) {
  const projectSpendings = data.spendings
    .filter(s => project.spendingIds.includes(s.spendingId))
    .map(s => ({
      spending: s,
      amountFromThisProject: s.projects.find(p => p.projectId === project.projectId)?.amount || 0
    }))
    .sort((a, b) => b.amountFromThisProject - a.amountFromThisProject)
    .slice(0, 3);

  topSpendings.push(...projectSpendings);
}
// 結果: 9事業 × 3支出先 = 最大27支出先（重複除外で実際は少ない）
```

## ノード数の見積もり

- **列1（府省庁）**: 3ノード
- **列2（事業・予算）**: 9ノード（3府省庁 × 3事業）
- **列3（事業・支出）**: 9ノード（同じ事業、金額は支出額）
- **列4（支出先）**: 最大27ノード（9事業 × 3支出先、重複除外で実際は15程度）

**合計**: 約36-48ノード

## リンク数の見積もり

- **府省庁 → 事業（予算）**: 9リンク
- **事業（予算） → 事業（支出）**: 9リンク
- **事業（支出） → 支出先**: 27リンク

**合計**: 45リンク

## 可視化のポイント

### 1. 予算と支出の差の可視化

事業（予算）ノードと事業（支出）ノードの高さの違いで、予算と支出の差が一目で分かる：

```
[事業A（予算）]  ────┐
   30兆円         │ 25兆円（リンクの太さ）
                  ├──→ [事業A（支出）]
                  │        25兆円
                  │
                  └─→ 5兆円の差（未執行・繰越など）
```

### 2. ラベル表示

各ノードには以下を表示：
- ノード名（府省庁名、事業名、支出先名）
- 金額（兆円表記）
- 列3（事業・支出）には執行率も表示

例：
```
厚生労働省（予算） (93.33兆円)
基礎年金給付に必要な経費（予算） (30.04兆円)
基礎年金給付に必要な経費（支出） (28.50兆円 / 執行率95%)
日本年金機構 (10.20兆円)
```

### 3. 色分け

- **列1（府省庁）**: 府省庁ごとに異なる色
- **列2（事業・予算）**: 所属府省庁と同じ色
- **列3（事業・支出）**: 所属府省庁と同じ色（やや薄め）
- **列4（支出先）**: グレー系統

### 4. ツールチップ

各ノードにカーソルを合わせると詳細情報を表示：

**府省庁ノード:**
- 府省庁名
- 総予算額
- 選択された事業数
- 局・庁数

**事業（予算）ノード:**
- 事業名
- 府省庁名
- 局・庁名
- 予算額（当初予算、補正予算、繰越など）

**事業（支出）ノード:**
- 事業名
- 支出額
- 執行率
- 支出先数

**支出先ノード:**
- 支出先名
- 法人番号
- 所在地
- 受領総額
- 支出元事業数

## データファイル

### 入力
- `public/data/rs2024-structured.json` - 完全データ

### 出力
- `public/data/rs2024-preset-top3.json` - Top3プリセット

### プリセットデータ構造

```typescript
interface RS2024PresetData {
  metadata: PresetMetadata;
  sankey: {
    nodes: SankeyNode[];  // 4列のノード
    links: SankeyLink[];  // 3種類のリンク
  };
}
```

## 実装の注意点

### 1. 事業ノードの重複

同じ事業が列2（予算）と列3（支出）に2回登場する。
IDを明確に区別する必要がある：
- 列2: `project-budget-{projectId}`
- 列3: `project-spending-{projectId}`

### 2. 予算と支出の差

予算額と支出額が異なる場合、リンク2の太さは`min(予算額, 支出額)`とする。
これにより、予算超過（支出 > 予算）や未執行（予算 > 支出）が視覚的に分かる。

### 3. 支出先の重複

複数の事業から同じ支出先に支出がある場合、支出先ノードは1つにまとめる。
複数のリンクが同じ支出先ノードに集約される。

## UIレイアウト

### ヘッダー
- タイトル: 「RS2024 サンキー図（Top3）」
- サブタイトル: 「府省庁 → 事業（予算） → 事業（支出） → 支出先の予算・支出フロー」

### 統計パネル
- カバー率
- 選択予算額
- 選択支出額
- 執行率（選択データ全体）
- 府省庁数/事業数/支出先数

### サンキー図
- 高さ: 800px
- 左右マージン: 各200px（長いラベルに対応）
- ノード間隔: 24px
- ノード幅: 18px

### フッター
- 生成日時
- データソース

## 将来の拡張

### Top5, Top10プリセット
- より詳細な分析用に、Top5やTop10プリセットも生成可能

### 階層ドリルダウン
- 府省庁をクリックすると、その府省庁の局・庁レベルまで展開
- 事業をクリックすると、支出先ブロックレベルまで展開

### フィルタリング機能
- 執行率でフィルタリング
- 予算規模でフィルタリング
- 特定府省庁のみ表示

### 比較機能
- 2024年度と2023年度の比較
- 当初予算と補正後予算の比較
