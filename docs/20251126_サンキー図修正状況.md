# サンキー図修正状況 - 2025年11月26日

## 実施した修正

### 1. 「その他の府省庁」「その他の事業」のリンク値を支出額に変更

**問題**: ノード値は予算額だが、リンク値も予算額になっていたため、サンキー図のバランスが崩れていた。

**修正内容**:
- `DataSelection` interfaceに支出額フィールドを追加
  - `otherMinistriesSpending: number` - 「その他の府省庁」の支出額
  - `otherProjectsSpendingByMinistry: Map<string, number>` - 「その他の事業」の支出額（府省庁ごと）

- `selectData`関数で支出額を計算
  - グローバルビュー: [app/lib/sankey-generator.ts:283-290](app/lib/sankey-generator.ts#L283-L290)
  - 府省庁ビュー: [app/lib/sankey-generator.ts:265-271](app/lib/sankey-generator.ts#L265-L271)
  - 各府省庁の「その他の事業」: [app/lib/sankey-generator.ts:308-314](app/lib/sankey-generator.ts#L308-L314)

- リンク値を支出額に変更
  - 「その他の府省庁」→「その他の支出先」: [app/lib/sankey-generator.ts:947](app/lib/sankey-generator.ts#L947)
  - 「その他の事業」→「その他の支出先」: [app/lib/sankey-generator.ts:971](app/lib/sankey-generator.ts#L971)
  - 「その他の事業」→「その他」: [app/lib/sankey-generator.ts:838](app/lib/sankey-generator.ts#L838)

### 2. 「その他の事業」ノードを予算側・支出側に分離

**問題**: 府省庁ビューで「その他の事業」が1つのノードしかなく、予算額と支出額の違いが表現できていなかった。

**修正内容**:
- 「その他の事業」支出側ノードを新規作成: [app/lib/sankey-generator.ts:730-757](app/lib/sankey-generator.ts#L730-L757)
  - ID: `project-spending-other-${ministry.id}`
  - 値: `otherSpending`（支出額）
- 予算側→支出側のリンクを追加
  - 値: `Math.min(otherBudget, otherSpending)`

### 3. 事業ビューの府省庁ノード値を修正

**問題**: 事業ビューで府省庁ノードの値が府省庁全体の予算額になっていた。

**修正内容**: [app/lib/sankey-generator.ts:592-594](app/lib/sankey-generator.ts#L592-L594)
```typescript
const ministryValue = (targetProjectName || targetMinistryName)
  ? topProjects.filter(p => p.ministry === ministry.name).reduce((sum, p) => sum + p.totalBudget, 0)
  : ministry.totalBudget;
```

### 4. projectOffset機能の実装（その他の事業のページネーション）

**実装内容**:
- 状態変数追加: [app/sankey/page.tsx:19](app/sankey/page.tsx#L19)
- URL同期: [app/sankey/page.tsx:47-60](app/sankey/page.tsx#L47-L60), [app/sankey/page.tsx:78-82](app/sankey/page.tsx#L78-L82)
- クリックハンドラ: [app/sankey/page.tsx:183-192](app/sankey/page.tsx#L183-L192)
- API対応: [app/api/sankey/route.ts:7](app/api/sankey/route.ts#L7), [app/api/sankey/route.ts:18](app/api/sankey/route.ts#L18)
- データ生成: [app/lib/sankey-generator.ts:255](app/lib/sankey-generator.ts#L255)

---

## 確認結果と残課題

### Topビュー

**確認結果**:
- ❌ 「その他の府省庁」ノードの金額が53.38兆円と表示されている
- ✅ 期待値: 約34兆円（予算額）

**問題の原因**:
- ノード値が正しく設定されていない可能性
- または、リンクの合計からノード値が再計算されている可能性（サンキー図ライブラリの仕様）

**対応が必要**:
- ノード値とリンクの整合性を確認
- サンキー図ライブラリ（@nivo/sankey）がノード値をどう扱うか調査

### 省庁ビュー

**確認結果**:
- ✅ 「その他の事業」が予算側・支出側の2つのノードとして表示
- ✅ 適切にリンクされている

**状態**: 改善されている

### 事業ビュー

**確認結果**:
- ❌ 左に府省庁ノードが表示されない
- ❌ 左には事業（予算）ノードがあるが、金額が事業（支出）と同じ
- ❌ 右側の支出先ノードの上の方に、府省庁ノードが金額0円で表示

**問題の原因**:
1. **府省庁ノードが表示されない**:
   - 事業ビューでは府省庁→事業（予算）のリンクが作成されない
   - [app/lib/sankey-generator.ts:653](app/lib/sankey-generator.ts#L653): `if (!targetProjectName)` 条件でリンク作成をスキップ
   - リンクがないノードは@nivo/sankeyが描画しない可能性

2. **事業（予算）ノードの金額が支出と同じ**:
   - 事業（予算）→事業（支出）のリンク値が問題
   - [app/lib/sankey-generator.ts:719](app/lib/sankey-generator.ts#L719): `Math.min(project.totalBudget, project.totalSpendingAmount)`
   - サンキー図ライブラリがリンク値でノード値を上書きしている可能性

3. **0円の府省庁ノードが右側に表示**:
   - 府省庁ノードが作成されるが、リンクがないため、右側に移動している
   - または、データに存在しない支出先として誤って表示されている

**対応が必要**:
- 事業ビューでの府省庁ノードの扱いを見直し
  - オプション1: 府省庁ノードを完全に削除
  - オプション2: 府省庁→事業（予算）のリンクを作成
- 事業（予算）ノードの値を正しく設定
- 0円ノードの削除ロジックを実装

---

## 未実装の要件

### 4. 0円の支出先ノード削除

**要件**:
> 一番右のノードに、省庁の０円ノードと、その他の０円ノードがあるが支出先名としてデータになければ表示不要（支出先に存在するのであれば０円でも表示する）

**実装方針**:
1. 受取先ノード生成時に、実際の支出額が0円でデータに存在しないノードをフィルタ
2. リンクが存在しないノードを削除
3. @nivo/sankeyの設定で孤立ノードを非表示にする

**実装箇所**: [app/lib/sankey-generator.ts:732-762](app/lib/sankey-generator.ts#L732-L762) (Recipient Nodes生成部分)

### 5. 支出ビューの全面的な見直し

**現在の実装**: [app/lib/sankey-generator.ts:426-547](app/lib/sankey-generator.ts#L426-L547)

**要件**:
1. **支出だけの世界**: すべて支出項目であるべき
   - 現在: 予算ベースのノードが含まれている可能性

2. **左端のノードは事業(支出)の金額を省庁ごとに集計したノード**
   - 現在: 事業ノードが個別に表示されている
   - 必要: 府省庁ごとに事業の支出を集計したノードを作成

3. **支出先のTopNに含まれていないものは省庁毎に「その他の事業」ノードとして見える化**
   - 現在: 実装されていない
   - 必要: 府省庁ごとに「その他の事業」ノードを作成し、TopN外の事業の支出を集約

**実装方針**:

```
支出ビューの構造（3列）:

Column 1: 府省庁別の事業（支出）集計ノード
  - 厚生労働省（支出）
  - 国土交通省（支出）
  - その他の府省庁（支出）

Column 2: 事業（支出）ノード + 府省庁別「その他の事業」
  - 基礎年金給付に必要な経費（支出）
  - 道路整備事業（支出）
  - ...
  - 厚生労働省-その他の事業（支出）
  - 国土交通省-その他の事業（支出）

Column 3: 支出先ノード（選択された1件）
  - 東京都
```

**データフロー**:
1. 選択された支出先に支出している事業を取得
2. 事業をTopN選択（支出額順）
3. 各事業を府省庁別にグループ化
4. 府省庁ごとに：
   - TopN事業の支出額を合計 → 個別の事業ノード
   - TopN外事業の支出額を合計 → 「その他の事業」ノード
5. 府省庁レベルのノードを作成（その府省庁の全事業の支出額合計）

**実装ステップ**:
1. `selectData`関数で支出ビュー用のデータ選択ロジックを書き直し
2. `buildSankeyData`関数で支出ビュー専用の3列構造を実装
3. リンク生成：
   - 府省庁→事業
   - 府省庁→「その他の事業」
   - 事業→支出先
   - 「その他の事業」→支出先

---

## 技術的な注意点

### サンキー図のノード値とリンク値の関係

@nivo/sankeyライブラリの仕様:
- ノードの値は、そのノードに流入するリンクの合計値で**上書き**される
- したがって、ノードに設定した`value`は参考値であり、実際の描画では使用されない場合がある
- ノードのサイズは、流入リンクと流出リンクの**最大値**で決まる

**影響**:
- 「その他の府省庁」ノードの値を予算額（34兆円）に設定しても、流出リンクの合計（53兆円）でノードサイズが決まる
- 予算と支出の差額を正しく表現するには、5列構造を維持し、Column 3→4の間で変換を明示する必要がある

### 5列構造の意図

```
Column 1: 予算総計 (予算額)
Column 2: 府省庁（予算） (予算額)
Column 3: 事業（予算） (予算額)
Column 4: 事業（支出） (支出額)  ← ここで予算から支出に変換
Column 5: 支出先 (支出額)
```

- Column 3→4のリンク値は `Math.min(予算額, 支出額)` を使用
- これにより、予算が支出に変換される様子を視覚化

---

## データ構造の補足

### BudgetRecord の主要フィールド

```typescript
interface BudgetRecord {
  projectId: number;
  projectName: string;
  totalBudget: number;        // 予算額
  totalSpendingAmount: number; // 支出額
  executionRate: number;       // 執行率
  spendingIds: number[];       // 関連する支出先ID
  ministry: string;
  bureau: string;
  // ...
}
```

### SpendingRecord の主要フィールド

```typescript
interface SpendingRecord {
  spendingId: number;
  spendingName: string;        // 支出先名
  totalSpendingAmount: number; // この支出先への支出総額
  projectCount: number;        // この支出先に支出している事業数
  projects: Array<{
    projectId: number;
    amount: number;            // この事業からこの支出先への支出額
  }>;
  corporateNumber: string;
  location: string;
  // ...
}
```

---

## 推奨する次のステップ

### 優先度: 高

1. **事業ビューの府省庁ノード問題の修正**
   - 府省庁ノードを完全に削除する（最もシンプル）
   - または、府省庁→事業（予算）のリンクを条件付きで作成

2. **0円ノード削除**
   - リンクが存在しないノードをフィルタリング
   - 実装難易度: 低

### 優先度: 中

3. **支出ビューの再設計**
   - 3列構造の実装
   - 府省庁別集計ノードの作成
   - 府省庁別「その他の事業」ノードの作成
   - 実装難易度: 高（全面的な書き直しが必要）

### 優先度: 低

4. **Topビューの「その他の府省庁」ノード値の問題調査**
   - @nivo/sankeyの仕様確認
   - カスタムノード値の設定方法を調査
   - 実装難易度: 中（ライブラリの深い理解が必要）

---

## 参考情報

### 関連ファイル

- **フロントエンド**: `app/sankey/page.tsx` (859行)
- **API**: `app/api/sankey/route.ts` (31行)
- **データ生成**: `app/lib/sankey-generator.ts` (1000+行)
- **型定義**:
  - `types/structured.ts` - データ構造
  - `types/preset.ts` - サンキー図の型
  - `types/sankey.ts` - Nivoサンキー用の型

### 関連ドキュメント

- `docs/サンキー図可視化仕様書.md` - サンキー図の設計仕様
- `docs/構造化JSON仕様書.md` - データ構造の仕様
- `CLAUDE.md` - プロジェクト全体の技術概要

### @nivo/sankey ドキュメント

- 公式サイト: https://nivo.rocks/sankey/
- GitHub: https://github.com/plouc/nivo

---

## 変更履歴

- 2025-11-26: 初版作成
  - 「その他の府省庁」「その他の事業」のリンク値修正
  - 「その他の事業」ノードの分離
  - 事業ビューの府省庁ノード値修正
  - projectOffset機能実装
