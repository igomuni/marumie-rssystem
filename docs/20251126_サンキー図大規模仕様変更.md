# ã‚µãƒ³ã‚­ãƒ¼å›³å¤§è¦æ¨¡ä»•æ§˜å¤‰æ›´ - 2025å¹´11æœˆ26æ—¥

## å¤‰æ›´ã®èƒŒæ™¯

ã€Œãã®ä»–ã®åºœçœåºã€ãƒãƒ¼ãƒ‰ã®é‡‘é¡è¡¨ç¤ºå•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€Topãƒ“ãƒ¥ãƒ¼ã®æ§‹é€ ã‚’æ ¹æœ¬çš„ã«å¤‰æ›´ã™ã‚‹ã€‚
æ”¯å‡ºå…ˆTopNã‚’èµ·ç‚¹ã¨ã—ã¦ã€é€†æ–¹å‘ã«äº‹æ¥­ãƒ»åºœçœåºã‚’çµã‚Šè¾¼ã‚€æ–¹å¼ã«å¤‰æ›´ã™ã‚‹ã€‚

---

## æ–°ä»•æ§˜ã®æ¦‚è¦

### Topãƒ“ãƒ¥ãƒ¼ï¼ˆGlobal Viewï¼‰

#### ãƒ‡ãƒ¼ã‚¿é¸æŠãƒ•ãƒ­ãƒ¼ï¼ˆæ”¯å‡ºå…ˆèµ·ç‚¹ï¼‰

```
1. æ”¯å‡ºå…ˆTopNï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30ï¼‰ã‚’é¸æŠ
   - ã€Œãã®ä»–ã€ï¼ˆæ”¯å‡ºå…ˆå=ã€Œãã®ä»–ã€ï¼‰ã¯é™¤å¤–
   - offset/limitã«ã‚ˆã‚‹ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ

2. TopNæ”¯å‡ºå…ˆã«ãƒªãƒ³ã‚¯ã™ã‚‹äº‹æ¥­ã‚’æŠ½å‡º
   - å„äº‹æ¥­ã®ã€ŒTopNæ”¯å‡ºå…ˆã¸ã®æ”¯å‡ºé¡ã€ã‚’è¨ˆç®—
   - ãã®é‡‘é¡é †ã«ã‚½ãƒ¼ãƒˆ

3. äº‹æ¥­ãŒæ‰€å±ã™ã‚‹åºœçœåºã‚’æŠ½å‡º
   - ã™ã¹ã¦ã®åºœçœåºã‚’è¡¨ç¤ºï¼ˆäºˆç®—é¡é †ï¼‰

4. ã€Œãã®ä»–ã€ãƒãƒ¼ãƒ‰ã‚’åˆ¥é€”é›†è¨ˆ
   - æ”¯å‡ºå…ˆåãŒã€Œãã®ä»–ã€ã®ã™ã¹ã¦ã®æ”¯å‡º

5. ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ãƒãƒ¼ãƒ‰ã‚’è¨ˆç®—
   - TopNå¤–ã®æ”¯å‡ºå…ˆã¸ã®æ”¯å‡º
   - ã€Œãã®ä»–ã€ã‚’é™¤ã
```

#### ã‚µãƒ³ã‚­ãƒ¼å›³æ§‹é€ 

```
äºˆç®—ç·è¨ˆ
  â”œâ”€ åºœçœåºAï¼ˆäºˆç®—é¡ï¼‰
  â”‚   â”œâ”€ äº‹æ¥­A1 â†’ äº‹æ¥­A1ï¼ˆæ”¯å‡ºï¼‰â†’ æ”¯å‡ºå…ˆX
  â”‚   â”œâ”€ äº‹æ¥­A2 â†’ äº‹æ¥­A2ï¼ˆæ”¯å‡ºï¼‰â†’ æ”¯å‡ºå…ˆY
  â”‚   â””â”€ äº‹æ¥­An â†’ äº‹æ¥­Anï¼ˆæ”¯å‡ºï¼‰â†’ ãã®ä»– / ãã®ä»–ã®æ”¯å‡ºå…ˆ
  â”œâ”€ åºœçœåºBï¼ˆäºˆç®—é¡ï¼‰
  â”‚   â””â”€ ...
  â””â”€ ... (å…¨åºœçœåº)

æœ€çµ‚ã‚«ãƒ©ãƒ :
  â”œâ”€ æ”¯å‡ºå…ˆ1ï¼ˆTopNï¼‰
  â”œâ”€ æ”¯å‡ºå…ˆ2ï¼ˆTopNï¼‰
  â”œâ”€ ...
  â”œâ”€ æ”¯å‡ºå…ˆNï¼ˆTopNï¼‰
  â”œâ”€ ãã®ä»–ï¼ˆæ”¯å‡ºå…ˆå=ã€Œãã®ä»–ã€ï¼‰
  â””â”€ ãã®ä»–ã®æ”¯å‡ºå…ˆï¼ˆTopNå¤– + ã‚¯ãƒªãƒƒã‚¯ã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
```

#### é‡è¦ãªå¤‰æ›´ç‚¹

1. **ã€Œãã®ä»–ã®äº‹æ¥­ã€ãƒãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„**
   - Topãƒ“ãƒ¥ãƒ¼ã§ã¯ã€TopNæ”¯å‡ºå…ˆã«ãƒªãƒ³ã‚¯ã™ã‚‹äº‹æ¥­ã®ã¿è¡¨ç¤º
   - åºœçœåºã‹ã‚‰ç›´æ¥å„äº‹æ¥­ã¸ãƒªãƒ³ã‚¯

2. **ã€Œãã®ä»–ã®åºœçœåºã€ãƒãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„**
   - ã™ã¹ã¦ã®åºœçœåºã‚’è¡¨ç¤º

3. **ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ã‚¯ãƒªãƒƒã‚¯ã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**
   - offsetã‚’å¢—ã‚„ã—ã¦æ¬¡ã®TopNæ”¯å‡ºå…ˆã‚’è¡¨ç¤º
   - å†å¸°çš„ãªãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆTopN+ã¨ã—ã¦æ·±å €ã‚Šï¼‰

### åºœçœåºãƒ“ãƒ¥ãƒ¼ï¼ˆMinistry Viewï¼‰

#### ã€Œãã®ä»–ã®äº‹æ¥­ã€ã®å®šç¾©

- **åºœçœåºãƒ“ãƒ¥ãƒ¼ã§ã®äº‹æ¥­TopNä»¥å¤–**
- å¾“æ¥é€šã‚Šã€åºœçœåºå†…ã®äº‹æ¥­ã‚’TopNé¸æŠã—ã€æ®‹ã‚Šã‚’ã€Œãã®ä»–ã®äº‹æ¥­ã€ã¨ã—ã¦é›†ç´„

#### ã‚µãƒ³ã‚­ãƒ¼å›³æ§‹é€ 

```
åºœçœåºA
  â”œâ”€ äº‹æ¥­A1 â†’ äº‹æ¥­A1ï¼ˆæ”¯å‡ºï¼‰â†’ æ”¯å‡ºå…ˆ / ãã®ä»– / ãã®ä»–ã®æ”¯å‡ºå…ˆ
  â”œâ”€ äº‹æ¥­A2 â†’ äº‹æ¥­A2ï¼ˆæ”¯å‡ºï¼‰â†’ æ”¯å‡ºå…ˆ / ãã®ä»– / ãã®ä»–ã®æ”¯å‡ºå…ˆ
  â”œâ”€ ...
  â””â”€ ãã®ä»–ã®äº‹æ¥­ï¼ˆäºˆç®—ï¼‰â†’ ãã®ä»–ã®äº‹æ¥­ï¼ˆæ”¯å‡ºï¼‰â†’ ãã®ä»– / ãã®ä»–ã®æ”¯å‡ºå…ˆ
```

### äº‹æ¥­ãƒ“ãƒ¥ãƒ¼ï¼ˆProject Viewï¼‰

#### ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ã®å®šç¾©

- **äº‹æ¥­ãƒ“ãƒ¥ãƒ¼ã§ã®æ”¯å‡ºå…ˆTopNä»¥å¤–**
- äº‹æ¥­å†…ã®æ”¯å‡ºå…ˆã‚’TopNé¸æŠã—ã€æ®‹ã‚Šã‚’ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ã¨ã—ã¦é›†ç´„

#### ã‚µãƒ³ã‚­ãƒ¼å›³æ§‹é€ 

```
äºˆç®—ç·è¨ˆ
  â”œâ”€ äº‹æ¥­Xï¼ˆäºˆç®—ï¼‰â†’ äº‹æ¥­Xï¼ˆæ”¯å‡ºï¼‰
      â”œâ”€ æ”¯å‡ºå…ˆ1ï¼ˆTopNï¼‰
      â”œâ”€ æ”¯å‡ºå…ˆ2ï¼ˆTopNï¼‰
      â”œâ”€ ...
      â”œâ”€ ãã®ä»–ï¼ˆæ”¯å‡ºå…ˆå=ã€Œãã®ä»–ã€ï¼‰
      â””â”€ ãã®ä»–ã®æ”¯å‡ºå…ˆï¼ˆTopNå¤–ï¼‰
```

### æ”¯å‡ºãƒ“ãƒ¥ãƒ¼ï¼ˆSpending Viewï¼‰

#### ã€Œãã®ä»–ã®äº‹æ¥­ã€ã®å®šç¾©

- **æ”¯å‡ºå…ƒäº‹æ¥­TopNä»¥å¤–**
- æ”¯å‡ºå…ˆã¸ã®æ”¯å‡ºå…ƒäº‹æ¥­ã‚’TopNé¸æŠã—ã€æ®‹ã‚Šã‚’ã€Œãã®ä»–ã®äº‹æ¥­ã€ã¨ã—ã¦é›†ç´„

#### ã‚µãƒ³ã‚­ãƒ¼å›³æ§‹é€ ï¼ˆ3åˆ—ï¼‰

```
åºœçœåºåˆ¥äº‹æ¥­ï¼ˆæ”¯å‡ºï¼‰é›†è¨ˆ
  â”œâ”€ åšç”ŸåŠ´åƒçœï¼ˆæ”¯å‡ºï¼‰â†’ äº‹æ¥­1 / äº‹æ¥­2 / ãã®ä»–ã®äº‹æ¥­ â†’ æ”¯å‡ºå…ˆX
  â”œâ”€ å›½åœŸäº¤é€šçœï¼ˆæ”¯å‡ºï¼‰â†’ äº‹æ¥­3 / äº‹æ¥­4 / ãã®ä»–ã®äº‹æ¥­ â†’ æ”¯å‡ºå…ˆX
  â””â”€ ...
```

---

## å®Ÿè£…çŠ¶æ³

### âœ… å®Œäº†

1. **Topãƒ“ãƒ¥ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿é¸æŠãƒ­ã‚¸ãƒƒã‚¯** [app/lib/sankey-generator.ts:273-335](app/lib/sankey-generator.ts#L273-L335)
   - æ”¯å‡ºå…ˆTopNé¸æŠï¼ˆoffset/limitå¯¾å¿œï¼‰
   - TopNæ”¯å‡ºå…ˆã«ãƒªãƒ³ã‚¯ã™ã‚‹äº‹æ¥­ã‚’æŠ½å‡º
   - äº‹æ¥­ã®æ”¯å‡ºé¡é †ã‚½ãƒ¼ãƒˆ
   - åºœçœåºã®æŠ½å‡ºï¼ˆã™ã¹ã¦è¡¨ç¤ºï¼‰

### ğŸ”„ é€²è¡Œä¸­

2. **Topãƒ“ãƒ¥ãƒ¼ã®ã‚µãƒ³ã‚­ãƒ¼å›³ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯**
   - åºœçœåºãƒãƒ¼ãƒ‰ç”Ÿæˆï¼ˆå®Œäº†ï¼‰
   - äº‹æ¥­ãƒãƒ¼ãƒ‰ç”Ÿæˆï¼ˆè¦ä¿®æ­£ï¼‰
   - æ”¯å‡ºå…ˆãƒãƒ¼ãƒ‰ç”Ÿæˆï¼ˆè¦ä¿®æ­£ï¼‰
   - ãƒªãƒ³ã‚¯ç”Ÿæˆï¼ˆè¦ä¿®æ­£ï¼‰
   - ã€Œãã®ä»–ã€ãƒãƒ¼ãƒ‰ï¼ˆè¦ä¿®æ­£ï¼‰
   - ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ãƒãƒ¼ãƒ‰ï¼ˆè¦å®Ÿè£…ï¼‰

### â³ æœªç€æ‰‹

3. **ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©
   - offsetå¢—åŠ ãƒ­ã‚¸ãƒƒã‚¯

4. **å„ãƒ“ãƒ¥ãƒ¼ã®ã€Œãã®ä»–ã®äº‹æ¥­ã€ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ä»•æ§˜èª¿æ•´**
   - åºœçœåºãƒ“ãƒ¥ãƒ¼: ã€Œãã®ä»–ã®äº‹æ¥­ã€å®šç¾©ç¢ºèª
   - äº‹æ¥­ãƒ“ãƒ¥ãƒ¼: ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€å®šç¾©ç¢ºèª
   - æ”¯å‡ºãƒ“ãƒ¥ãƒ¼: ã€Œãã®ä»–ã®äº‹æ¥­ã€å®šç¾©ç¢ºèª

5. **å‹•ä½œç¢ºèªã¨ãƒ†ã‚¹ãƒˆ**

---

## ä¸»è¦ãªå®Ÿè£…èª²é¡Œ

### 1. Topãƒ“ãƒ¥ãƒ¼å°‚ç”¨ã®ã‚µãƒ³ã‚­ãƒ¼å›³ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯

ç¾åœ¨ã®`buildSankeyData`é–¢æ•°ã¯ã€ã™ã¹ã¦ã®ãƒ“ãƒ¥ãƒ¼ã§å…±é€šã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã€‚
Topãƒ“ãƒ¥ãƒ¼ã§ã¯ä»¥ä¸‹ã®ç‚¹ãŒç•°ãªã‚‹ï¼š

- ã€Œãã®ä»–ã®äº‹æ¥­ã€ãƒãƒ¼ãƒ‰ã‚’ä½œæˆã—ãªã„
- åºœçœåºã‹ã‚‰ç›´æ¥äº‹æ¥­ã¸ãƒªãƒ³ã‚¯ï¼ˆåºœçœåºå†…ã®TopNé¸æŠãªã—ï¼‰
- æ”¯å‡ºå…ˆã¯æ—¢ã«`topSpendings`ã«è¨­å®šæ¸ˆã¿
- ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ã®è¨ˆç®—æ–¹æ³•ãŒç•°ãªã‚‹

#### å®Ÿè£…æ–¹é‡

**Option A**: Topãƒ“ãƒ¥ãƒ¼å°‚ç”¨ã®åˆ†å²ã‚’`buildSankeyData`å†…ã«è¿½åŠ 
```typescript
if (!targetMinistryName && !targetProjectName && !targetRecipientName) {
  // Global Viewå°‚ç”¨ãƒ­ã‚¸ãƒƒã‚¯
} else {
  // æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯
}
```

**Option B**: `buildSankeyData`ã‚’2ã¤ã®é–¢æ•°ã«åˆ†å‰²
```typescript
function buildSankeyDataGlobal(...) { }
function buildSankeyDataOther(...) { }
```

â†’ **æ¨å¥¨: Option A**ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ç¶­æŒï¼‰

### 2. ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ã®è¨ˆç®—

#### Global Viewã§ã®è¨ˆç®—å¼

```typescript
ãã®ä»–ã®æ”¯å‡ºå…ˆ = å…¨æ”¯å‡ºå…ˆã®æ”¯å‡ºç·é¡ - TopNæ”¯å‡ºå…ˆã®æ”¯å‡ºç·é¡ - ã€Œãã®ä»–ã€ã¸ã®æ”¯å‡ºç·é¡
```

#### å®Ÿè£…å ´æ‰€

[app/lib/sankey-generator.ts:910-950](app/lib/sankey-generator.ts#L910-L950) ä»˜è¿‘
ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ãƒãƒ¼ãƒ‰ç”Ÿæˆéƒ¨åˆ†ã‚’ä¿®æ­£

#### å¿…è¦ãªãƒ‡ãƒ¼ã‚¿

- `topSpendings`: TopNæ”¯å‡ºå…ˆï¼ˆæ—¢ã«é¸æŠæ¸ˆã¿ï¼‰
- `totalOtherNamedAmount`: ã€Œãã®ä»–ã€ã¸ã®æ”¯å‡ºç·é¡ï¼ˆæ—¢å­˜ï¼‰
- å…¨æ”¯å‡ºç·é¡: `data.spendings.reduce((sum, s) => sum + s.totalSpendingAmount, 0)`

### 3. ã€Œãã®ä»–ã®äº‹æ¥­ã€é–¢é€£ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤ãƒ»æ¡ä»¶åˆ†å²

#### å‰Šé™¤å¯¾è±¡ï¼ˆTopãƒ“ãƒ¥ãƒ¼ã®ã¿ï¼‰

- [app/lib/sankey-generator.ts:662-695](app/lib/sankey-generator.ts#L662-L695): ã€Œãã®ä»–ã®äº‹æ¥­ã€ãƒãƒ¼ãƒ‰ç”Ÿæˆ
- [app/lib/sankey-generator.ts:730-757](app/lib/sankey-generator.ts#L730-L757): ã€Œãã®ä»–ã®äº‹æ¥­ï¼ˆæ”¯å‡ºï¼‰ã€ãƒãƒ¼ãƒ‰ç”Ÿæˆ
- é–¢é€£ã™ã‚‹ãƒªãƒ³ã‚¯ç”Ÿæˆã‚³ãƒ¼ãƒ‰

#### æ¡ä»¶åˆ†å²ã®è¿½åŠ 

```typescript
// ã€Œãã®ä»–ã®äº‹æ¥­ã€ã¯Topãƒ“ãƒ¥ãƒ¼ä»¥å¤–ã§ä½œæˆ
if (targetMinistryName || targetProjectName || targetRecipientName) {
  // æ—¢å­˜ã®ã€Œãã®ä»–ã®äº‹æ¥­ã€ãƒãƒ¼ãƒ‰ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
}
```

### 4. ãƒªãƒ³ã‚¯ç”Ÿæˆã®ä¿®æ­£

#### Global Viewã§ã®ãƒªãƒ³ã‚¯æ§‹é€ 

```
Total Budget â†’ Ministry
Ministry â†’ Project Budget
Project Budget â†’ Project Spending (Math.min(budget, spending))
Project Spending â†’ TopN Recipients
Project Spending â†’ ãã®ä»–
Project Spending â†’ ãã®ä»–ã®æ”¯å‡ºå…ˆ
```

#### æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®å·®åˆ†

- åºœçœåº â†’ ã€Œãã®ä»–ã®äº‹æ¥­ã€ã¸ã®ãƒªãƒ³ã‚¯: **å‰Šé™¤**ï¼ˆTopãƒ“ãƒ¥ãƒ¼ã®ã¿ï¼‰
- ã€Œãã®ä»–ã®äº‹æ¥­ã€ â†’ ã€Œãã®ä»–ã€ã¸ã®ãƒªãƒ³ã‚¯: **å‰Šé™¤**ï¼ˆTopãƒ“ãƒ¥ãƒ¼ã®ã¿ï¼‰
- ã€Œãã®ä»–ã®äº‹æ¥­ã€ â†’ ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ã¸ã®ãƒªãƒ³ã‚¯: **å‰Šé™¤**ï¼ˆTopãƒ“ãƒ¥ãƒ¼ã®ã¿ï¼‰

---

## ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å¤‰æ›´

### GenerateOptionsï¼ˆAPI Parametersï¼‰

å¤‰æ›´ãªã—ã€‚æ—¢å­˜ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å¯¾å¿œå¯èƒ½ã€‚

```typescript
{
  offset: number;           // æ”¯å‡ºå…ˆã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼ˆGlobal Viewï¼‰
  limit: number;            // åºœçœåºæ•°ï¼ˆGlobal Viewã§ã¯æœªä½¿ç”¨ï¼‰
  projectLimit: number;     // äº‹æ¥­æ•°ï¼ˆMinistry/Spending Viewï¼‰
  spendingLimit: number;    // æ”¯å‡ºå…ˆæ•°ï¼ˆGlobal/Project Viewï¼‰
  // ...
}
```

### DataSelection

å¤‰æ›´ãªã—ã€‚æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§å¯¾å¿œå¯èƒ½ã€‚

```typescript
{
  topMinistries: Ministry[];
  topProjects: BudgetRecord[];
  topSpendings: SpendingRecord[];
  otherMinistriesBudget: number;      // Global Viewã§ã¯0
  otherMinistriesSpending: number;    // Global Viewã§ã¯0
  otherProjectsBudgetByMinistry: Map<string, number>;  // Global Viewã§ã¯ç©º
  otherProjectsSpendingByMinistry: Map<string, number>; // Global Viewã§ã¯ç©º
  otherNamedSpendingByProject: Map<number, number>;
  otherSpendingsByProject: Map<number, number>;
}
```

---

## å®Ÿè£…æ‰‹é †ï¼ˆæ¨å¥¨ï¼‰

### Phase 1: Topãƒ“ãƒ¥ãƒ¼ã®ã‚µãƒ³ã‚­ãƒ¼å›³ç”Ÿæˆï¼ˆæœ€å„ªå…ˆï¼‰

1. **ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ **
   - å…¨æ”¯å‡ºç·é¡ - TopN - ã€Œãã®ä»–ã€
   - [app/lib/sankey-generator.ts:910-950](app/lib/sankey-generator.ts#L910-L950)

2. **Topãƒ“ãƒ¥ãƒ¼ç”¨ã®æ¡ä»¶åˆ†å²è¿½åŠ **
   - `buildSankeyData`é–¢æ•°å†…ã«`if (!targetMinistryName && !targetProjectName && !targetRecipientName)`
   - ã€Œãã®ä»–ã®äº‹æ¥­ã€ãƒãƒ¼ãƒ‰ç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—

3. **ãƒªãƒ³ã‚¯ç”Ÿæˆã®ä¿®æ­£**
   - åºœçœåº â†’ äº‹æ¥­ï¼ˆäºˆç®—ï¼‰: TopNæ”¯å‡ºå…ˆã«ãƒªãƒ³ã‚¯ã™ã‚‹äº‹æ¥­ã®ã¿
   - äº‹æ¥­ï¼ˆæ”¯å‡ºï¼‰â†’ æ”¯å‡ºå…ˆ: TopN + ã€Œãã®ä»–ã€ + ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€

4. **å‹•ä½œç¢ºèª**
   - `npm run dev`ã§Topãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
   - ã™ã¹ã¦ã®åºœçœåºãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹
   - TopNæ”¯å‡ºå…ˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹
   - ã€Œãã®ä»–ã€ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹

### Phase 2: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…

1. **ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©**
   - [app/sankey/page.tsx:220-240](app/sankey/page.tsx#L220-L240)ä»˜è¿‘
   - `if (actualNode.id === 'recipient-other-aggregated')`
   - `setOffset(prev => prev + spendingLimit)`

2. **å‹•ä½œç¢ºèª**
   - ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ã‚¯ãƒªãƒƒã‚¯ã§æ¬¡ã®TopNæ”¯å‡ºå…ˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹

### Phase 3: ä»–ãƒ“ãƒ¥ãƒ¼ã®èª¿æ•´

1. **åºœçœåºãƒ“ãƒ¥ãƒ¼**: ã€Œãã®ä»–ã®äº‹æ¥­ã€å®šç¾©ç¢ºèªï¼ˆå¤‰æ›´ãªã—ï¼‰
2. **äº‹æ¥­ãƒ“ãƒ¥ãƒ¼**: ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€å®šç¾©ç¢ºèªï¼ˆå¤‰æ›´ãªã—ï¼‰
3. **æ”¯å‡ºãƒ“ãƒ¥ãƒ¼**: ã€Œãã®ä»–ã®äº‹æ¥­ã€å®šç¾©ç¢ºèªï¼ˆè¦æ¤œè¨ï¼‰

### Phase 4: ç·åˆãƒ†ã‚¹ãƒˆ

1. å„ãƒ“ãƒ¥ãƒ¼ã®é·ç§»
2. ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
3. ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆã§ã®æˆ»ã‚Šæ“ä½œ

---

## ãƒªã‚¹ã‚¯ã¨æ‡¸å¿µäº‹é …

### 1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- Topãƒ“ãƒ¥ãƒ¼ã§ã™ã¹ã¦ã®åºœçœåºã‚’è¡¨ç¤º â†’ ãƒãƒ¼ãƒ‰æ•°å¢—åŠ 
- TopNæ”¯å‡ºå…ˆã¸ã®äº‹æ¥­æ¤œç´¢ â†’ è¨ˆç®—é‡å¢—åŠ ï¼ˆO(N*M)ï¼‰
- ææ¡ˆ: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–

### 2. è¤‡é›‘æ€§

- `buildSankeyData`é–¢æ•°ãŒç´„1000è¡Œ â†’ ä¿å®ˆæ€§ä½ä¸‹
- ææ¡ˆ: é–¢æ•°åˆ†å‰²ã€ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 

### 3. æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿

- åºœçœåº/äº‹æ¥­/æ”¯å‡ºãƒ“ãƒ¥ãƒ¼ãŒå£Šã‚Œã‚‹å¯èƒ½æ€§
- ææ¡ˆ: æ®µéšçš„å®Ÿè£…ã€å„ãƒ•ã‚§ãƒ¼ã‚ºã§ãƒ†ã‚¹ãƒˆ

### 4. ä»•æ§˜ã®æ›–æ˜§æ€§

- ã€ŒTopNæ”¯å‡ºå…ˆã«ãƒªãƒ³ã‚¯ã™ã‚‹äº‹æ¥­ã€ã®é¸æŠåŸºæº–
  - ç¾åœ¨: æ”¯å‡ºé¡é †
  - ä»£æ›¿æ¡ˆ: äºˆç®—é¡é †ã€äº‹æ¥­åé †
- ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ–¹æ³•
  - ç¾åœ¨: offset += spendingLimit
  - ä»£æ›¿æ¡ˆ: ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€å°‚ç”¨ãƒ“ãƒ¥ãƒ¼

---

## å‚è€ƒæƒ…å ±

### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯**: [app/lib/sankey-generator.ts](app/lib/sankey-generator.ts) (1000+ lines)
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: [app/sankey/page.tsx](app/sankey/page.tsx) (894 lines)
- **API**: [app/api/sankey/route.ts](app/api/sankey/route.ts) (31 lines)

### æ—¢å­˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [CLAUDE.md](../CLAUDE.md) - ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- [ã‚µãƒ³ã‚­ãƒ¼å›³ä¿®æ­£çŠ¶æ³.md](./20251126_ã‚µãƒ³ã‚­ãƒ¼å›³ä¿®æ­£çŠ¶æ³.md) - å‰å›ã®ä¿®æ­£å†…å®¹
- [ã‚µãƒ³ã‚­ãƒ¼å›³å¯è¦–åŒ–ä»•æ§˜æ›¸.md](./ã‚µãƒ³ã‚­ãƒ¼å›³å¯è¦–åŒ–ä»•æ§˜æ›¸.md) - å…ƒã®ä»•æ§˜

### ã‚³ãƒ¼ãƒ‰ä¾‹

#### Topãƒ“ãƒ¥ãƒ¼ã§ã®ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€è¨ˆç®—

```typescript
// Global View: Calculate "Other Recipients" amount
if (!targetMinistryName && !targetProjectName && !targetRecipientName) {
  const topSpendingIds = new Set(topSpendings.map(s => s.spendingId));

  let otherRecipientsAmount = 0;
  for (const spending of data.spendings) {
    // Exclude TopN and "ãã®ä»–"
    if (!topSpendingIds.has(spending.spendingId) && spending.spendingName !== 'ãã®ä»–') {
      otherRecipientsAmount += spending.totalSpendingAmount;
    }
  }

  // Also need to calculate which projects contribute to "Other Recipients"
  // This is complex - need to track project â†’ non-TopN recipients spending
}
```

#### åºœçœåº â†’ äº‹æ¥­ãƒªãƒ³ã‚¯ç”Ÿæˆï¼ˆTopãƒ“ãƒ¥ãƒ¼ï¼‰

```typescript
// Global View: Ministry -> Project Budget links
if (!targetMinistryName && !targetProjectName && !targetRecipientName) {
  // In Global View, link ministries to projects that contribute to TopN recipients
  for (const ministry of topMinistries) {
    const ministryProjects = topProjects.filter(p => p.ministry === ministry.name);
    for (const project of ministryProjects) {
      links.push({
        source: `ministry-budget-${ministry.id}`,
        target: `project-budget-${project.projectId}`,
        value: project.totalBudget,
      });
    }
  }
} else {
  // Other views: existing logic with "Other Projects"
}
```

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼**
   - ä»•æ§˜ã®ç†è§£ç¢ºèª
   - å®Ÿè£…æ–¹é‡ã®åˆæ„

2. **Phase 1ã®å®Ÿè£…é–‹å§‹**
   - ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€è¨ˆç®—
   - Topãƒ“ãƒ¥ãƒ¼å°‚ç”¨ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
   - å‹•ä½œç¢ºèª

3. **å¿…è¦ã«å¿œã˜ã¦ä»•æ§˜ã®è©³ç´°åŒ–**
   - ã€Œãã®ä»–ã®æ”¯å‡ºå…ˆã€ã¸ã®ãƒªãƒ³ã‚¯å€¤ã®è¨ˆç®—æ–¹æ³•
   - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã®è¡¨ç¤ºå†…å®¹

---

## å¤‰æ›´å±¥æ­´

- 2025-11-26: åˆç‰ˆä½œæˆ
  - æ–°ä»•æ§˜ã®æ¦‚è¦ã¾ã¨ã‚
  - å®Ÿè£…çŠ¶æ³æ•´ç†
  - å®Ÿè£…èª²é¡Œã®æ´—ã„å‡ºã—
  - å®Ÿè£…æ‰‹é †ã®ææ¡ˆ
