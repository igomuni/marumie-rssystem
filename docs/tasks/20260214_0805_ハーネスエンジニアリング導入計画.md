# ハーネスエンジニアリング導入計画

> 参考: [Claude Code Webを10並列で回す！チームみらいの選挙支援ツールを作りながら構築した、超並列LLMコーディングを実現するためのハーネスエンジニアリング](https://note.com/jujunjun110/n/n66306cab294a) by Jun Ito
>
> 実装例: [team-mirai-volunteer/video-processor](https://github.com/team-mirai-volunteer/video-processor)

作成日: 2026-02-14

---

## 1. ハーネスエンジニアリングとは

**ハーネス** = LLMを「現場で再現性高く動かす」ための外側の仕組み

Claude Code のハーネスは以下の部品で構成される：

| 部品 | 役割 |
|------|------|
| `CLAUDE.md` | セッション開始時に自動読み込みされるプロジェクト知識・ルール |
| **Slash Commands** (`.claude/commands/`) | 再利用可能なワークフロー定義 |
| **Git Hooks** (`pre-push` 等) | コミット前後の品質チェック自動化 |
| **Subagents / Parallel Worktrees** | 並列タスク実行 |

### video-processor リポジトリでの実践パターン

チームみらいの実際のリポジトリを確認した。コマンド構成：

| コマンド | 用途 |
|---------|------|
| `/plan` | 設計ドキュメント自動生成 → `docs/tasks/YYYYMMDD_HHMM_*.md` に保存 |
| `/pr` | フィーチャーブランチ作成・品質チェック・PR作成を一発実行 |
| `/review` | 設計レビュー（アーキテクチャ・型・命名の観点） |
| `/resolve-reviews` | GitHub PRの未解決レビューコメントへの自動対応 |
| `/sync` | developブランチに戻ってリモートと同期 |
| `/backend-{feature}` | 機能ガイドを読んでからバックエンド修正 |
| `/front-{feature}` | 機能ガイドを読んでからフロントエンド修正 |

**CLAUDE.md の特徴**（~80行と簡潔）:
- Quick Reference（コマンド一覧）
- Architecture（レイヤー設計）
- Coding Standards
- Git Hooks（`pre-push` で lint + typecheck 自動実行）
- 「修正時に読むべきガイド」テーブル → `docs/` の詳細ガイドへリンク

---

## 2. 現状の評価

### 既に実装済み ✅

- **`.claude/settings.local.json`**: 権限設定が充実
- **データパイプライン**: `npm run normalize/generate-structured/compress-data` でスクリプト化済み
- **URL状態管理**: ビュー遷移が URL で管理されシェアリング可能

### 改善が必要な点 ❌

| 要素 | 現状 | 目標 |
|------|------|------|
| `CLAUDE.md` | 700行超・詳細すぎる | 簡潔なリファレンス（~100行）+ 詳細は `docs/` に分離 |
| Slash Commands | `.claude/commands/` なし | `/plan` `/pr` `/review` など実装 |
| Git Hooks | なし | `pre-push` で lint 自動実行 |
| レイヤーガイド | CLAUDE.md に埋もれている | `docs/` に独立したガイドとして分離 |

---

## 3. 導入計画

### Step 1: `.claude/commands/` の作成 【最優先】

以下のスラッシュコマンドを作成する。

#### `/plan`（設計ドキュメント自動生成）

video-processor の実装をそのまま参考にする。

```markdown
---
allowed-tools: Bash(TZ=Asia/Tokyo date:*), Write, Read, Glob, Grep
argument-hint: <設計内容の説明>
description: 設計ドキュメントを作成する
---
```

**実行内容**:
1. Why（目的）を明確化。不明な場合はユーザーに確認
2. 関連コード・ドキュメントを調査（CLAUDE.md のレイヤー設計を参照）
3. `docs/YYYYMMDD_HHMM_{タイトル}.md` に保存（既存の命名規則に合わせる）
4. ユーザーのレビューを待つ（そのまま実装には進まない）

#### `/pr`（フィーチャーブランチ→PR作成）

```markdown
---
allowed-tools: Bash(git:*), Bash(gh:*), Bash(npm:*)
description: フィーチャーブランチを作成してPRを出す
---
```

**実行内容**:
1. 変更内容確認
2. フィーチャーブランチ作成（develop 上にいる場合）
3. 品質チェック: `npm run lint` → TypeScript チェック
4. コミット → プッシュ → `gh pr create`

#### `/review`（設計レビュー）

```markdown
---
description: 現在の変更に対して設計レビューを行う
---
```

**チェック観点**:
- レイヤー設計との整合性（`app/lib/` に UI ロジックが入っていないか等）
- 型安全性（TypeScript の any 使用等）
- 命名規則
- パフォーマンス（Sankey 再レンダリング、API キャッシュ等）

#### `/sankey`（Sankey 機能実装コンテキスト読み込み）

```markdown
---
description: Sankey図関連の実装を行う
---
```

**実行内容**:
1. `docs/sankey-architecture-guide.md` を読む（後述、新規作成）
2. `app/lib/sankey-generator.ts` と `app/sankey/page.tsx` の構造を把握
3. ユーザーの指示に従って実装

#### `/data-update`（データパイプライン更新）

```markdown
---
allowed-tools: Bash(npm:*), Bash(git:*), Bash(gzip:*)
description: RS Systemデータを更新して圧縮・Gitに反映する
---
```

**実行内容**:
1. `data/download/RS_2024/` の ZIP ファイル確認
2. `npm run normalize` → `npm run generate-structured` → `npm run compress-data`
3. ファイルサイズ確認・差分確認
4. `public/data/rs2024-structured.json.gz` をコミット

---

### Step 2: CLAUDE.md のリファクタリング 【高優先】

現在の 700 行超の CLAUDE.md を **~100行のクイックリファレンス** に縮小し、詳細を `docs/` に分離する。

**CLAUDE.md に残す内容**:
- Quick Reference（主要コマンド）
- Architecture（レイヤー設計ルール・短く）
- Data Units（1円単位 - CRITICAL）
- Git/Deployment フロー
- 「修正時に読むべきガイド」テーブル → `docs/` へのリンク

**`docs/` に分離する内容**:

| 新規ファイル | 内容 |
|------------|------|
| `docs/sankey-architecture-guide.md` | Sankey 生成アルゴリズム・5列構造・ノードタイプ |
| `docs/data-pipeline-guide.md` | CSV → JSON 処理パイプライン詳細 |
| `docs/api-guide.md` | `/api/sankey` エンドポイント仕様 |

**「修正時に読むべきガイド」テーブル（CLAUDE.md に追加）**:

| 修正対象 | 読むべきガイド |
|---------|---------------|
| Sankey 生成ロジック | [docs/sankey-architecture-guide.md](docs/sankey-architecture-guide.md) |
| データパイプライン | [docs/data-pipeline-guide.md](docs/data-pipeline-guide.md) |
| API エンドポイント | [docs/api-guide.md](docs/api-guide.md) |

---

### Step 3: Git Hooks の設定 【中優先】

`pre-push` フックで lint + TypeScript チェックを自動実行。

**CLAUDE.md に追記するルール**（video-processor と同形式）:

```markdown
## Git Hooks

- **pre-push hook**: lint が自動実行される
- **失敗時の対応**: hookエラーはスキップせず必ず修正する
  - `--no-verify`でのスキップは原則禁止
```

**`.husky/pre-push`（または `scripts/pre-push.sh`）**:

```bash
#!/bin/bash
npm run lint
```

---

### Step 4: Git Worktrees で並列実行 【低優先】

独立したタスクを並列実行する場合のパターン：

```bash
# 例: UIとAPIを並列で実装
git worktree add ../rssystem-ui feature/new-spending-view
git worktree add ../rssystem-api feature/new-api-endpoint

# それぞれのディレクトリで別の claude セッションを起動
cd ../rssystem-ui && claude
cd ../rssystem-api && claude
```

---

## 4. 実装順序

```
[今すぐ]
1. mkdir -p .claude/commands
2. /plan コマンド作成（最重要）
3. /pr コマンド作成
4. /review コマンド作成
5. /sankey コマンド作成
6. /data-update コマンド作成

[次のセッション]
7. CLAUDE.md リファクタリング + docs/ 分離ガイド作成
8. Git Hooks (pre-push) 設定

[必要になったとき]
9. Git Worktrees による並列実行
```

---

## 5. 参考資料

- [チームみらい video-processor リポジトリ](https://github.com/team-mirai-volunteer/video-processor)
- [Claude Code Webを10並列で回す！ハーネスエンジニアリング](https://note.com/jujunjun110/n/n66306cab294a)
- [Claude Code 公式ドキュメント - Skills/Hooks/Sub-agents](https://code.claude.com/docs/ja/features-overview)
