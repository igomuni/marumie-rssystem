# 支出先一覧に間接支出先（再委託先）を復元する設計

**作成日**: 2026年2月14日

---

## 1. Why（目的）

再委託フロー実装時（`generate-structured-json.ts` 改修）に、間接支出ブロック（`isDirectFromGov !== true`）を `continue` でスキップする処理が追加された。

その結果、`GoToおきなわキャンペーン事業受託企業体` のように **5-1 CSVには存在するが政府からの直接支出ではない** 支出先が `SpendingRecord` から消え、支出先一覧に表示されなくなった。

5-1 CSV に登場する支出先を **すべて** 支出先一覧に表示し、直接支出か委託経由かを `委託元` 列で区別できるようにする。

---

## 2. 根本原因

```typescript
// generate-structured-json.ts: line 521
if (isDirectFromGov !== true) {
  indirectBlockCount++;
  indirectBlockAmount += amount;
  continue;  // ← ここで間接支出先をすべてスキップ
}
```

このスキップは「総支出額の二重計上防止」のために導入されたが、
副作用として支出先一覧からの表示消失が発生した。

---

## 3. 設計方針

### 方針: スキップをやめ、`委託元` メタデータを付与して含める

- `continue` を削除し、間接支出先も `spendingMap` に追加する
- `SpendingProject` に `isDirectFromGov?: boolean` と `sourceBlockName?: string` を追加
- 委託元（`sourceBlockName`）は 5-2 CSV の逆引きマップで取得する
- **総支出額の統計値は引き続き直接支出のみでカウント**（二重計上防止は維持）

---

## 4. データフロー（修正後）

```
5-2 CSV → buildBlockFlowMap()
           ├─ outflows: sourceKey → SpendingBlockFlow[]  （既存）
           ├─ isDirectFromGov: targetKey → true           （既存）
           └─ inflows: targetKey → sourceBlockName        ← 追加（逆引きマップ）

5-1 CSV → buildSpendingRecords()
           ├─ isDirectFromGov == true  → SpendingRecord に追加（従来通り）
           └─ isDirectFromGov != true  → SpendingRecord に追加 ← continue を削除
                                          └─ SpendingProject.isDirectFromGov = false
                                          └─ SpendingProject.sourceBlockName = inflows から取得
```

---

## 5. 修正ファイル一覧

| ファイル | 変更内容 | 規模 |
|---------|---------|------|
| `types/structured.ts` | `SpendingProject` に `isDirectFromGov?` と `sourceBlockName?` を追加 | 小 |
| `scripts/generate-structured-json.ts` | `inflows` 逆引きマップ構築、`continue` 削除、メタデータ付与 | 中 |
| `client/components/SpendingListModal.tsx` | `委託元` 列の追加 | 小 |
| **データ再生成** | `npm run generate-structured && npm run compress-data` | 必須 |

---

## 6. 実装詳細

### 6.1 `types/structured.ts`

```typescript
export interface SpendingProject {
  projectId: number;
  amount: number;
  blockNumber: string;
  blockName: string;
  contractSummary: string;
  contractMethod: string;
  isDirectFromGov?: boolean;   // 追加: 政府から直接支出か（falseなら委託経由）
  sourceBlockName?: string;    // 追加: 委託元の支出先ブロック名
}
```

### 6.2 `scripts/generate-structured-json.ts`

#### `buildBlockFlowMap()` に `inflows` マップを追加

```typescript
interface BlockFlowMap {
  outflows: Map<string, SpendingBlockFlow[]>;
  isDirectFromGov: Map<string, boolean>;
  inflows: Map<string, string>;  // 追加: targetKey → sourceBlockName
}

// flowRows ループ内で追加
if (sourceBlock && isDirectStr === 'FALSE') {
  const targetKey = `${projectIdStr}_${targetBlock}`;
  inflows.set(targetKey, row.支出元の支出先ブロック名);  // 追加
  // 既存の outflows 処理...
}
```

#### `buildSpendingRecords()` の `continue` を削除

```typescript
if (isDirectFromGov !== true) {
  indirectBlockCount++;
  indirectBlockAmount += amount;
  // continue; ← 削除
}

// SpendingProject に委託元情報を付与
const sourceBlockName = blockFlowMap.inflows.get(blockKey);
// projects に追加するとき:
project.isDirectFromGov = isDirectFromGov === true;
project.sourceBlockName = sourceBlockName;  // 間接の場合のみ設定
```

#### 統計値は直接支出のみを対象に維持

`totalBudgetAmount` や `totalSpendingAmount` の計算では引き続き直接支出のみを集計する（`indirectBlockAmount` はログ用のみに留める）。

### 6.3 `client/components/SpendingListModal.tsx`

テーブルに `委託元` 列を追加:

```tsx
// 直接支出か委託経由かを表示
const source = project.isDirectFromGov === false
  ? project.sourceBlockName || '委託経由'
  : '直接';
```

列表示イメージ:

| 支出先名 | 合計支出額 | 委託元 |
|---------|---------|------|
| 博報堂 | 2.47兆円 | （空欄） |
| GoToおきなわキャンペーン事業受託企業体 | XXX億円 | 博報堂 |

---

## 7. 確認ポイント

- [ ] `npm run generate-structured` が正常終了する
- [ ] `GoToおきなわキャンペーン事業受託企業体` が支出先一覧に表示される
- [ ] 直接支出先の `委託元` 列が空欄 or "直接" になっている
- [ ] 間接支出先の `委託元` 列に委託元名（博報堂等）が表示される
- [ ] 総支出額の統計値に変化がない（二重計上していない）
- [ ] `npm run build` がエラーなく通る

---

## 8. リスク評価

| リスク | 可能性 | 対策 |
|--------|--------|------|
| 統計値の変化（二重計上） | 中 | `indirectBlockAmount` の集計ロジックは変えない。`statistics.totalSpendingAmount` の元となるカウンターは直接支出のみに絞る |
| JSON サイズの増加 | 中 | 間接支出先が増えるため 46MB→増加の可能性。圧縮後は許容範囲のはず |
| `inflows` が取得できない間接ブロック | 低 | `sourceBlockName` が `undefined` の場合 `'委託経由'` にフォールバック |
