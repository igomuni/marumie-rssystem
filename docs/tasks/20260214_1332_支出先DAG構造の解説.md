# 支出先データがDAG（グラフ）である理由

**作成日**: 2026年2月14日
**目的**: 支出先データをツリー構造ではなくフラット＋隣接リストで管理すべき理由の解説

---

## 例1: 電気・ガス価格激変緩和対策等事業（プロジェクト7259）

```mermaid
graph LR
    GOV[経済産業省]

    GOV -->|4,892億円 直接| TEPEP[東京電力EP]
    GOV -->|2,926億円 直接| KEPCO[関西電力]
    GOV -->|2,288億円 直接| CHUBU[中部電力ミライズ]
    GOV -->|2.37兆円 直接・事務局| HAKO[株式会社博報堂]

    HAKO -->|補助金パススルー 間接| TEPEP
    HAKO -->|補助金パススルー 間接| CHUBU
    HAKO -->|補助金パススルー 間接| TG[東京瓦斯]
    HAKO -->|再委託費135億円| HAKOP[博報堂プロダクツ]
    HAKO -->|中小100社以上 間接| OTHER[...]

    style TEPEP fill:#fca5a5
    style CHUBU fill:#fca5a5
```

> 🔴 **東京電力EP・中部電力ミライズは2つの矢印が入ってくる（親が2つ）**
> → ツリー構造にできない

---

## 例2: GoToトラベル（地域観光事業支援）

```mermaid
graph LR
    OCA[観光庁]

    OCA -->|直接| JIMO[GoToトラベル事務局]

    JIMO -->|間接補助金| OKI[GoToおきなわキャンペーン\n事業受託企業体]
    JIMO -->|間接補助金| HKDO[北海道GoToトラベル\n事業受託企業体]
    JIMO -->|間接補助金| TOHK[東北GoToトラベル...]
    JIMO -->|...| DOT[47都道府県分]

    style OKI fill:#fca5a5
    style HKDO fill:#fca5a5
    style TOHK fill:#fca5a5
```

> 🔴 **GoToおきなわは親が1つなのでツリーでも表現できる**
> しかし例1と混在するため、データ構造全体をツリーにはできない

---

## ツリー構造にしようとすると（問題の可視化）

```mermaid
graph LR
    GOV[経済産業省]

    GOV -->|直接| TEPEP_A["東京電力EP ①\n4,892億円\n直接受取分"]
    GOV -->|直接| HAKO[博報堂]
    HAKO -->|間接| TEPEP_B["東京電力EP ②\n間接受取分"]

    TEPEP_A -. 同じ会社 .-> TEPEP_B

    style TEPEP_A fill:#fca5a5
    style TEPEP_B fill:#fca5a5
```

> ❌ 同一の会社が2ノードに分裂
> ❌「東京電力EPの合計受取額は？」が答えられない
> ❌ JSONサイズが膨張（同一支出先が何十回も複製される）

---

## 現在の設計（フラット＋隣接リスト）が正しい形

```mermaid
graph LR
    subgraph SR["SpendingRecord（フラットリスト）"]
        direction TB
        TEPEP["東京電力EP\namount: 4,892億円\nprojects[7259].isDirectFromGov: true\n---\noutflows: なし"]
        TEPEP2["東京電力EP（博報堂経由分）\namount: XXX億円\nprojects[7259].isDirectFromGov: false\nprojects[7259].sourceBlockName: 博報堂\n← 今回の修正で復元"]
        OKI["GoToおきなわキャンペーン事業受託企業体\namount: XXX億円\nprojects[XXXX].isDirectFromGov: false\nprojects[XXXX].sourceBlockName: GoToトラベル事務局\n← 今回の修正で復元"]
    end
```

> ✅ 1エントリで管理・重複なし
> ✅「東京電力EPの合計受取額は？」→ `record.amount` を見るだけ
> ✅「GoToおきなわはどこから委託された？」→ `project.sourceBlockName` を見るだけ
> ✅ 委託元列で直接/間接を区別

---

## データ構造の比較まとめ

| 観点 | ツリー構造 | 現在の設計（隣接リスト） |
|------|-----------|------------------------|
| 実態との一致 | ✗ DAGを木に強制 | ✓ DAGをそのまま表現 |
| 同一支出先の重複 | ✗ 複数ノードに分裂 | ✓ 1エントリで管理 |
| 合計金額の集計 | ✗ 全ツリー走査が必要 | ✓ `record.amount` 参照のみ |
| 検索 | ✗ 再帰的走査が必要 | ✓ 配列フィルタで即検索 |
| JSONサイズ | ✗ 重複により膨張 | ✓ コンパクト |
| Sankey生成 | ✗ 複雑なデノーマライズ | ✓ 現在の実装がそのまま使える |
| 委託元の把握 | △ 親ノードを辿る | ✓ `sourceBlockName` で直参照 |

---

## 今回の修正方針

`generate-structured-json.ts` の `continue` を削除し、間接支出先も `SpendingRecord` に含める。
`SpendingProject.isDirectFromGov` と `SpendingProject.sourceBlockName` で直接/間接を区別する。

詳細設計: [20260214_1310_支出先一覧に再委託先を追加する設計.md](20260214_1310_支出先一覧に再委託先を追加する設計.md)
