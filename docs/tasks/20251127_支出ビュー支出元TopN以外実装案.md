# 支出ビュー「支出元(TopN以外)」実装案

## 概要

支出ビュー（Spending View）において、TopNで表示されないプロジェクトを集約した「支出元(TopN以外)」ノードを実装する提案。

## 現状

### Spending Viewの動作

- 特定の受給者（支出先）をクリックすると、その受給者に支出したプロジェクトを表示
- `projectLimit`（デフォルト20）でTopNプロジェクトを選択
- TopN以外のプロジェクトは非表示

### データフロー

```
app/lib/sankey-generator.ts (156-211行)

1. targetRecipientNameで受給者を検索
2. その受給者に支出した全プロジェクトを取得
3. 支出額でソート
4. topProjects = sortedProjects.slice(0, projectLimit) // TopNのみ選択
5. TopN以外のプロジェクトは破棄される
```

## 問題点

- TopN以外のプロジェクトからの支出が見えない
- 全体の支出額に対するカバレッジ率が不明
- ページネーションによる次のTopN表示ができない

## 実装案

### 1. データ選択の拡張 (selectData関数)

#### 変更箇所: app/lib/sankey-generator.ts 156-211行

```typescript
if (targetRecipientName) {
  // --- Spending View (Reverse Flow) ---
  const recipientSpendings = data.spendings.filter(s => s.spendingName === targetRecipientName);

  if (recipientSpendings.length > 0) {
    topSpendings = recipientSpendings;

    // 全プロジェクトの支出額を集計
    const contributingProjectIds = new Set<number>();
    const amountByProject = new Map<number, number>();

    for (const s of recipientSpendings) {
      for (const p of s.projects) {
        contributingProjectIds.add(p.projectId);
        const current = amountByProject.get(p.projectId) || 0;
        amountByProject.set(p.projectId, current + p.amount);
      }
    }

    const allContributingProjects = data.budgets.filter(b => contributingProjectIds.has(b.projectId));
    const sortedProjects = allContributingProjects.sort((a, b) => {
      return (amountByProject.get(b.projectId) || 0) - (amountByProject.get(a.projectId) || 0);
    });

    // TopN選択（projectOffsetでページネーション対応）
    topProjects = sortedProjects.slice(projectOffset, projectOffset + projectLimit);

    // 【新規追加】TopN以外のプロジェクト金額を集計
    let otherProjectsAmount = 0;

    // projectOffset前のプロジェクト（前ページ）
    for (let i = 0; i < projectOffset; i++) {
      if (i < sortedProjects.length) {
        const projectId = sortedProjects[i].projectId;
        otherProjectsAmount += amountByProject.get(projectId) || 0;
      }
    }

    // projectOffset + projectLimit以降のプロジェクト（後ページ）
    for (let i = projectOffset + projectLimit; i < sortedProjects.length; i++) {
      const projectId = sortedProjects[i].projectId;
      otherProjectsAmount += amountByProject.get(projectId) || 0;
    }

    // DataSelectionに追加情報を保存
    // 新しいフィールド: otherProjectsSpendingInSpendingView
    // （既存のotherSpendingsByProjectとは別物）

    // 府省庁の取得
    const ministryNames = new Set(topProjects.map(p => p.ministry));
    topMinistries = data.budgetTree.ministries
      .filter(m => ministryNames.has(m.name))
      .map(m => ({
        name: m.name,
        id: m.id,
        totalBudget: m.totalBudget,
        bureauCount: m.bureaus.length
      }));
  }
}
```

#### 必要な型定義追加

```typescript
interface DataSelection {
  topMinistries: Array<{ name: string; id: number; totalBudget: number; bureauCount: number }>;
  topProjects: BudgetRecord[];
  topSpendings: SpendingRecord[];
  otherProjectsBudgetByMinistry: Map<string, number>;
  otherProjectsSpendingByMinistry: Map<string, number>;
  otherSpendingsByProject: Map<number, number>;
  otherNamedSpendingByProject: Map<number, number>;

  // 【新規追加】Spending View用
  otherProjectsSpendingInSpendingView?: number;
  hasMoreProjects?: boolean; // ページネーション可能かどうか
}
```

### 2. Sankeyノード・リンク生成 (buildSankeyData関数)

#### 変更箇所: Spending View判定箇所に追加

```typescript
// Spending Viewの場合、"支出元(TopN以外)"ノードを追加
const isSpendingView = !!targetRecipientName;

if (isSpendingView && selection.otherProjectsSpendingInSpendingView && selection.otherProjectsSpendingInSpendingView > 0) {
  // Project Spending列に"支出元(TopN以外)"ノードを追加
  projectSpendingNodes.push({
    id: 'project-spending-other-spending-view',
    name: '支出元(TopN以外)',
    type: 'project-spending',
    value: selection.otherProjectsSpendingInSpendingView,
    details: {
      ministry: '複数府省庁',
      bureau: '',
      fiscalYear: 2024,
      executionRate: 0,
      spendingCount: 0,
    },
  });

  // リンク: "支出元(TopN以外)" → 受給者
  const targetRecipient = sankey.nodes.find(n => n.type === 'recipient' && n.name === targetRecipientName);
  if (targetRecipient) {
    links.push({
      source: 'project-spending-other-spending-view',
      target: targetRecipient.id,
      value: selection.otherProjectsSpendingInSpendingView,
    });
  }
}
```

### 3. UIでのクリックハンドリング (app/sankey/page.tsx)

#### 変更箇所: handleNodeClick関数

```typescript
// "支出元(TopN以外)"ノードのクリック処理
if (actualNode.type === 'project-spending' && actualNode.name === '支出元(TopN以外)') {
  if (viewMode === 'spending') {
    // projectOffsetを増やして次のTopNプロジェクトを表示
    setProjectOffset(prev => prev + spendingViewTopN);
  }
  return;
}
```

### 4. ページネーションのリセット処理

- Spending Viewに入るとき、projectOffsetを0にリセット
- 別の受給者をクリックしたときもリセット

## サンキー図の構造（実装後）

### Spending View (例: 受給者「総務省」を選択)

```
列1: Total Budget
  ↓
列2: Ministry Budget (複数府省庁)
  - 内閣府
  - 総務省
  - 経済産業省
  ↓
列3: Project Budget (複数事業)
  - 新型コロナ... (内閣府)
  - デジタル基盤... (総務省)
  - GX推進... (経済産業省)
  ↓
列4: Project Spending (支出元)
  - 新型コロナ... (2.84兆円)
  - デジタル基盤... (1.5兆円)
  - GX推進... (0.8兆円)
  - 支出元(TopN以外) (5.2兆円) ← 【新規】
  ↓
列5: Recipient (受給者)
  - 総務省 (10.34兆円)
```

## ページネーション動作

1. 初期状態: projectOffset=0, projectLimit=20 → Top20プロジェクトを表示
2. 「支出元(TopN以外)」クリック: projectOffset=20 → 21-40位のプロジェクトを表示
3. さらにクリック: projectOffset=40 → 41-60位のプロジェクトを表示
4. パンくずリストの「予算総計」クリック: projectOffset=0にリセット

## 色の扱い

- 「支出元(TopN以外)」ノードはグレー (#6b7280)
- 既存の色設定ロジック（app/sankey/page.tsx:563-569）に追加:

```typescript
if (name.startsWith('その他') ||
    name === '府省庁(TopN以外)' ||
    name === '事業(TopN以外)' ||
    name === '支出先(TopN以外)' ||
    name === '支出元(TopN以外)') {  // 【新規追加】
  return '#6b7280'; // グレー系
}
```

## 実装の優先度

- **必須**: データ選択とノード生成（TopN以外の金額集計と表示）
- **推奨**: ページネーション機能（次のTopN表示）
- **オプション**: 統計情報の表示（カバレッジ率など）

## 注意点

1. **パフォーマンス**: 大量のプロジェクト（例: 数千件）でもソートが高速に動作するか確認
2. **データ整合性**: otherProjectsSpendingInSpendingViewの計算が正確か検証
3. **UX**: ページネーションで前のページに戻る機能は不要（パンくずリストで戻る）
4. **エッジケース**:
   - TopN以外が0円の場合はノードを表示しない
   - 全プロジェクトがTopN内に収まる場合は「支出元(TopN以外)」を非表示

## 実装後のテスト項目

1. 受給者「総務省」をクリック → TopN（デフォルト20）プロジェクトが表示される
2. 「支出元(TopN以外)」が表示される（金額が0より大きい場合）
3. 「支出元(TopN以外)」をクリック → 次のTopNプロジェクトが表示される
4. パンくずリストで「予算総計」クリック → projectOffsetがリセットされる
5. 別の受給者をクリック → projectOffsetがリセットされる
6. TopN以外の金額が正しく計算されている（手動検証）

## 参考実装

- Global View: `府省庁(TopN以外)` (app/lib/sankey-generator.ts:665-674)
- Ministry View: `事業(TopN以外)` (app/lib/sankey-generator.ts:750-822)
- Global View: `支出先(TopN以外)` (app/lib/sankey-generator.ts:1118-1223)

これらの実装パターンを参考に、Spending View用の実装を行う。
