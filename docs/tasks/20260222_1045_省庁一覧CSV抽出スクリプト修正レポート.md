# 省庁一覧CSV抽出スクリプト修正レポート

**日付**: 2026-02-22
**対象スクリプト**: `scripts/extract-ministry-from-ichiran.py`
**出力ファイル**: `data/result/ministry_from_ichiran.csv`

---

## 背景

`r071215kouji.pdf`（府省庁一覧PDF）からCSVを生成するスクリプトで、2つの問題を修正した。

---

## 修正1: `矯正管区` が ORG_ENDS パターンに未登録（前セッション）

### 問題

`矯正管区` がCSVに一切出力されなかった。

### 原因

以下の正規表現に `区` が含まれていなかった。

```python
# 修正前
ORG_ENDS = re.compile(r'[局部所署台庁会校]$')

_ends_org = bool(re.search(r'[局部所署館庁校]$', norm)) or ...
```

`strip_count('矯正管区８')` → `'矯正管区'` の末尾 `区` がパターンにマッチせず、有効な組織名として認識されなかった。

### 修正

```python
# 修正後（line 202）
ORG_ENDS = re.compile(r'[局部所署台庁会校区]$')

# 修正後（line 319）
_ends_org = bool(re.search(r'[局部所署館庁校区]$', norm)) or (
    _cs != norm and bool(ORG_ENDS.search(_cs))
)
```

---

## 修正2: `矯正管区` の展開が別組織の地域プレフィックスを使用（本セッション）

### 問題

`矯正管区` が誤った地域名で展開されていた。

```
最高検察庁,,東京矯正管区,,,矯正管区８   ← 誤（高等検察庁の地域を流用）
最高検察庁,,大阪矯正管区,,,矯正管区８   ← 誤
...
最高検察庁,,福岡矯正管区,,,矯正管区８   ← 誤
```

期待値（PDF `＜北海道、東北、関東、中部、近畿、中国、四国、九州＾` から）:

```
最高検察庁,,北海道矯正管区,,,矯正管区８  ✓
最高検察庁,,東北矯正管区,,,矯正管区８   ✓
...
最高検察庁,,九州矯正管区,,,矯正管区８   ✓
```

### 原因: ページ境界をまたぐ `next_is_angle` の誤判定

スクリプトの「兄弟展開」メカニズム：

- あるブロック（例: `高等検察庁８`）に `＜...＾` 展開があった場合、`last_prefixes` に地域リストを保存する。
- 後続ブロックが同じ数字（`８`）を持つ場合、`next_is_angle=False` ならその `last_prefixes` を再利用して展開（兄弟展開）する。

PDFのページ構造:
- **17ページ末尾**: `高等検察庁８`（`＜札幌、仙台、東京…福岡＾` 展開付き）、`矯正管区８`（ページ最後のブロック）
- **18ページ先頭**: `＜北海道、東北、関東…九州＾`（`矯正管区` 用展開）

`next_is_angle` の計算は同一ページのブロックしか見ておらず、`矯正管区８` がページ17の最後にあるため `next_norm = ''` → `next_is_angle = False` と誤判定。これにより `高等検察庁` の地域リスト（札幌・仙台・東京…福岡）が `矯正管区` の展開に流用されていた。18ページの `＜北海道…九州＾` は `prev_bureau_base` が `''` のため無視された。

### 修正

`next_is_angle` の計算を**ページ境界をまたいで**行うよう変更。

```python
# 修正前（line 204）
for page in pages:
    blocks = join_continuation_lines(page)

    for idx, block in enumerate(blocks):
        ...
        next_norm = ''
        for j in range(idx + 1, len(blocks)):   # 同ページ内のみ
            nn = normalize_line(blocks[j])
            if nn:
                next_norm = nn
                break
        next_is_angle = bool(re.match(r'^＜', next_norm))
```

```python
# 修正後（line 204）
for page_idx, page in enumerate(pages):          # enumerate 追加
    blocks = join_continuation_lines(page)

    for idx, block in enumerate(blocks):
        ...
        next_norm = ''
        for j in range(idx + 1, len(blocks)):
            nn = normalize_line(blocks[j])
            if nn:
                next_norm = nn
                break
        # ページ末尾の場合は次ページ先頭ブロックも参照（跨ぎ展開対応）
        if not next_norm and page_idx + 1 < len(pages):
            next_page_blocks = join_continuation_lines(pages[page_idx + 1])
            for b in next_page_blocks:
                nn = normalize_line(b)
                if nn:
                    next_norm = nn
                    break
        next_is_angle = bool(re.match(r'^＜', next_norm))
```

### 修正後の出力

```
最高検察庁,地方支分部局,矯正管区８,,,
最高検察庁,地方支分部局,北海道矯正管区,,,矯正管区８
最高検察庁,地方支分部局,東北矯正管区,,,矯正管区８
最高検察庁,地方支分部局,関東矯正管区,,,矯正管区８
最高検察庁,地方支分部局,中部矯正管区,,,矯正管区８
最高検察庁,地方支分部局,近畿矯正管区,,,矯正管区８
最高検察庁,地方支分部局,中国矯正管区,,,矯正管区８
最高検察庁,地方支分部局,四国矯正管区,,,矯正管区８
最高検察庁,地方支分部局,九州矯正管区,,,矯正管区８
```

---

## 現在の出力統計

| 項目 | 値 |
|------|---|
| 総行数 | 1,702 |
| `＜...＾` 展開件数 | 264件 |
| alias付きエントリ | 41件 |

---

## 残課題・注意事項

- `法務局` は PDF上 `＜札幌、仙台、東京…福岡＾` で補完されているが、実際の支出先名は `大阪法務局` 等ではなく別表記の場合がある。ユーザー判断で **alias mapping** で対応予定。
- `bureau_alias` は現在 `地方` を含む展開名（例: `九州地方整備局`）に対して `地方` 除去版をDBチェックして付与する仕組み。`矯正管区` には `地方` が含まれないため alias は付与されない。
