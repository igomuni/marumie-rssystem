# みらいまる見え政治資金 可視化ページ実装計画

## 目的

チームみらいの公開政治資金データ（marumie.team-mir.ai）を素早く把握したいユーザーが、
CSV を手動で集計せずに収支の全体像・党費分布などをブラウザで見られるようにするため。

---

## データの概要

- **ソース**: `https://marumie.team-mir.ai/o/team-mirai` からDL した CSV
- **ファイル**: `data/download/transactions_team-mirai_2026-02-22.csv`（2.7MB・gitignore対象）
- **件数**: 27,532件（収入 13,383件 / 支出 14,149件）
- **期間**: 2025-05-07 〜 2025-12-06
- **総収入**: 約2.72億円 / **総支出**: 約1.65億円

### カラム構成

| カラム | 説明 | 値例 |
|--------|------|------|
| 日付 | `YYYY-MM-DD` | 2025-07-15 |
| 政治団体名 | 固定値 | 政党・チームみらい |
| タイプ | `収入` or `支出` | 収入 |
| 金額 | 整数（円） | 1500 |
| カテゴリ | 大分類 | 個人の負担する党費又は会費 |
| 詳細区分 | 小分類 | 党費 |
| ラベル | 任意の補足 | VERCEL |

### 主要カテゴリ（収入）

| カテゴリ | 詳細区分 | 件数 |
|---------|---------|------|
| 個人の負担する党費又は会費 | 党費 | 3,723件 |
| 個人からの寄附 | 個人からの寄附 | 9,627件 |
| その他の収入 | 立法事務費・返金等 | 16件 |

### 党費金額分布（判明済み）

| 金額 | 件数 | 割合 |
|------|------|------|
| 1,500円 | 2,710件 | 72.8% |
| 5,000円 | 698件 | 18.7% |
| 10,000円 | 298件 | 8.0% |
| その他（端数・高額） | 17件 | 0.5% |

---

## アーキテクチャ

既存の `mof-budget-overview` ページ（静的JSONをフェッチするパターン）に準拠する。

### 追加ファイル一覧

| ファイル | レイヤー | 役割 |
|---------|---------|------|
| `scripts/generate-mirai-summary.ts` | Data Pipeline | CSV → 集計JSON生成 |
| `public/data/mirai-summary.json` | Static Asset | 集計済みデータ（commit対象） |
| `types/mirai.ts` | Types | 集計JSONの型定義 |
| `app/mirai/page.tsx` | Page | UIメインページ |

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `package.json` | `generate-mirai` スクリプト追加 |
| `.gitignore` | `!/public/data/mirai-summary.json` 追記 |

### URL

`/mirai`

---

## データパイプライン

### スクリプト: `scripts/generate-mirai-summary.ts`

**入力**: `data/download/transactions_team-mirai_*.csv`（最新ファイルを自動検出）
**出力**: `public/data/mirai-summary.json`

生成するJSON構造:

```ts
{
  generatedAt: string,          // ISO日時
  sourceFile: string,           // 元CSVファイル名
  summary: {
    totalIncome: number,        // 総収入（円）
    totalExpense: number,       // 総支出（円）
    totalTransactions: number,  // 総件数
    dateRange: { from: string, to: string }  // "YYYY-MM"
  },
  monthly: Array<{
    month: string,              // "YYYY-MM"
    income: number,
    expense: number,
    incomeCount: number,
    expenseCount: number,
  }>,
  incomeByCategory: Array<{
    category: string,
    subCategory: string,
    amount: number,
    count: number,
  }>,
  expenseByCategory: Array<{
    category: string,
    amount: number,
    count: number,
  }>,
  partyFeeDistribution: Array<{
    amount: number,
    count: number,
    percentage: number,
  }>,
  donationDistribution: Array<{   // 個人寄附の分布（金額帯別）
    label: string,                // "〜999円", "1,000〜4,999円" など
    count: number,
    totalAmount: number,
  }>,
}
```

**npm スクリプト**:
```
"generate-mirai": "npx ts-node --project tsconfig.json scripts/generate-mirai-summary.ts"
```

---

## ページ仕様: `app/mirai/page.tsx`

`'use client'` コンポーネント。マウント時に `/public/data/mirai-summary.json` を fetch。

### セクション構成

#### 1. ヘッダー
- タイトル: 「チームみらい 政治資金ダッシュボード」
- データソースリンク（marumie.team-mir.ai へのリンク）
- 集計期間表示（dateRange）

#### 2. サマリーカード（3枚）
- 総収入: 約X.X億円（N件）
- 総支出: 約X.X億円（N件）
- 差引残高: 約X.X億円

#### 3. 月別収支推移
- 横軸: 月（2025-05 〜 2025-12）
- 縦軸: 金額（円）
- 収入バー（青系）と支出バー（赤系）の並列表示
- **実装**: `@nivo/bar`（`@0.99.0` を新規インストール）を使用

#### 4. 収入内訳
- 党費 / 個人寄附 / その他を金額・件数で表示
- シンプルな横棒グラフ（CSS `width` ベース）

#### 5. 党費金額分布
- 棒グラフ: 1,500円・5,000円・10,000円・その他の件数と割合
- 「72.8% が月1,500円」などの強調テキスト付き

#### 6. 個人寄附分布
- 金額帯別（〜999円 / 1,000〜4,999円 / 5,000〜9,999円 / 10,000円〜）の件数・金額

### スタイリング

既存ページ（`globals.css`）のスタイルを踏襲。新規CSSクラスは `app/mirai/` 内にスコープする（CSS Modules または `<style>` タグ）。

---

## レイヤー設計チェック

| チェック項目 | 結果 |
|------------|------|
| `scripts/` にUIロジックなし | OK（CSVパース・JSON出力のみ） |
| `app/lib/` にHTTP・Reactなし | OK（lib層への追加なし） |
| `client/components/` に直接APIコールなし | OK（コンポーネント追加なし） |
| `app/mirai/page.tsx` から fetch のみ | OK（`public/data/` の静的JSONを参照） |

---

## 実装順序

1. `types/mirai.ts` — 型定義
2. `scripts/generate-mirai-summary.ts` — CSVパーサー・集計スクリプト
3. `npm run generate-mirai` 実行 → `public/data/mirai-summary.json` 生成確認
4. `.gitignore` 更新 + `package.json` スクリプト追加
5. `@nivo/bar@0.99.0` インストール
6. `app/mirai/page.tsx` — ページ実装

---

## 注意事項

- `data/download/` は gitignore 対象のため、`mirai-summary.json` の生成はローカルで手動実行（`npm run generate-mirai`）し、生成物を commit する
- CSV ファイルのエンコーディングは `UTF-8 BOM付き`（`utf-8-sig` 相当）
- 金額は **整数（円単位）**（本プロジェクトの他データと同じ単位）
