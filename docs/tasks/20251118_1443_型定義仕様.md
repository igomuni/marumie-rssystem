# 型定義仕様書

**作成日**: 2025-11-18 14:43
**対象**: RS2024サンキー図システム

## 概要

本システムで使用する型定義の詳細仕様を記載する。TypeScriptの型安全性を活用し、開発効率とコード品質を向上させる。

---

## 1. Sankey図データ構造 (`types/sankey.ts`)

### 1.1 SankeyNode

Sankey図のノード（節点）を表現する型。

```typescript
interface SankeyNode {
  id: string;          // ノードの一意識別子
  nodeColor?: string;  // ノードの色（オプション）
}
```

**フィールド詳細**:
- `id`: ノードを一意に識別する文字列。リンクのsource/target参照に使用される
- `nodeColor`: ノードの表示色（16進数カラーコードまたはCSS色名）。未指定の場合は@nivoのデフォルトカラースキーム

**命名規則**:
- 予算ドリルダウン: `総予算` → `{省庁名}` → `{部局}` → `{課}` → `{係}` → `{管理番号}`
- 支出ボトムアップ: `{支出先名称}` → `{管理番号}` → `{係}` → `{課}` → `{部局}` → `{省庁名}` → `総支出`
- その他集約: `その他` （TopN集約時の残余）

### 1.2 SankeyLink

Sankey図のリンク（フロー）を表現する型。

```typescript
interface SankeyLink {
  source: string;  // 流出元ノードのID
  target: string;  // 流入先ノードのID
  value: number;   // フローの値（金額）
}
```

**フィールド詳細**:
- `source`: 流出元ノードの`id`（必ず`nodes`配列に存在すること）
- `target`: 流入先ノードの`id`（必ず`nodes`配列に存在すること）
- `value`: フローの量（千円単位の数値）。正の数値のみ有効

**バリデーションルール**:
- `source`と`target`が異なること（自己ループ禁止）
- `value > 0`（ゼロまたは負の値は無効）
- `source`, `target`のIDが`nodes`配列に存在すること

### 1.3 SankeyData

完全なSankey図データセット。

```typescript
interface SankeyData {
  nodes: SankeyNode[];
  links: SankeyLink[];
}
```

**データ整合性要件**:
1. すべてのリンクの`source`/`target`が`nodes`のいずれかの`id`に対応すること
2. ノードIDは重複しないこと
3. 孤立ノード（リンクを持たないノード）は避けること（表示が不自然になるため）

### 1.4 TopN設定

```typescript
type TopNValue = 5 | 10 | 20 | 50;
type TopNSettingsKey = 'budget-drilldown' | 'spending-bottomup';
```

**TopNValue**:
- サポートする集約レベル。上位N件を個別表示し、残りを「その他」に集約
- JSONファイル名: `budget-drilldown-top{5,10,20,50}.json`, `spending-bottomup-top{5,10,20,50}.json`

**TopNSettingsKey**:
- LocalStorageに保存する際のキー識別子
- 画面ごとに独立したTopN設定を保持

---

## 2. RSシステムCSVデータ型 (`types/rs-system.ts`)

### 2.1 OrganizationInfo

`1-1_2024_基本情報_組織情報.csv`の行データ。

```typescript
interface OrganizationInfo {
  管理番号: string;
  予算年度: string;
  会計区分: string;
  '所管コード（部局）': string;
  '所管名称（部局）': string;
  '所管コード（課）': string;
  '所管名称（課）': string;
  '所管コード（係）': string;
  '所管名称（係）': string;
}
```

**注意事項**:
- 階層データは**疎**（部局のみ、課まで、など）。係まで揃っているとは限らない
- `予算年度 === "2024"`でフィルタリング必須
- コードフィールドは数値的に見えるが文字列型（前ゼロ保持のため）

### 2.2 BudgetSummary

`2-1_2024_予算・執行_サマリ.csv`の行データ。

```typescript
interface BudgetSummary {
  管理番号: string;
  予算年度: string;
  '予算現額（千円）': string;
  '支出済額（千円）': string;
  '翌年度繰越額（千円）': string;
  '不用額（千円）': string;
}
```

**金額フィールドの処理**:
- 文字列型で格納（CSVパース時の数値精度問題回避）
- 使用時に`Number()`または`parseInt()`で数値変換
- カンマ区切りがある場合は除去: `value.replace(/,/g, '')`

### 2.3 SpendingInfo

`5-1_2024_支出先_支出情報.csv`の行データ。

```typescript
interface SpendingInfo {
  管理番号: string;
  支出先名称: string;
  '支出額（千円）': string;
  法人番号?: string;
}
```

**集約処理**:
- 同一`支出先名称`について、複数の`管理番号`から支出がある場合、合計して集約
- `法人番号`はオプション（個人支出先などで未記載の場合あり）

### 2.4 HierarchyPath

組織階層パスを正規化した構造。

```typescript
interface HierarchyPath {
  部局: string;
  課: string;
  係: string;
}
```

**正規化ルール** (`client/lib/buildHierarchyPath.ts`で実装):
- 空白・未入力フィールドは空文字列`""`とする
- 階層レベルがない場合も構造は保持（値が空文字列になるだけ）
- 前後の空白はトリム

---

## 3. 型使用例

### 3.1 予算ドリルダウンJSON生成

```typescript
import { SankeyData, SankeyNode, SankeyLink } from '@/types/sankey';
import { OrganizationInfo, BudgetSummary } from '@/types/rs-system';

const data: SankeyData = {
  nodes: [
    { id: '総予算' },
    { id: '財務省' },
    { id: '主計局' },
    // ...
  ],
  links: [
    { source: '総予算', target: '財務省', value: 5000000 },
    { source: '財務省', target: '主計局', value: 3000000 },
    // ...
  ]
};
```

### 3.2 TopN設定の保存・取得

```typescript
import { TopNValue, TopNSettingsKey } from '@/types/sankey';

const key: TopNSettingsKey = 'budget-drilldown';
const topN: TopNValue = 10;

localStorage.setItem(key, String(topN));
const saved = Number(localStorage.getItem(key) || '10') as TopNValue;
```

---

## 4. 型チェック戦略

### 4.1 コンパイル時チェック

- TypeScriptの`strict: true`を有効化
- 全インポート・エクスポートで型明示
- `any`型の使用を最小限に

### 4.2 ランタイムバリデーション

スクリプト実行時にデータ整合性を検証:

```typescript
function validateSankeyData(data: SankeyData): void {
  const nodeIds = new Set(data.nodes.map(n => n.id));

  for (const link of data.links) {
    if (!nodeIds.has(link.source)) {
      throw new Error(`Invalid source: ${link.source}`);
    }
    if (!nodeIds.has(link.target)) {
      throw new Error(`Invalid target: ${link.target}`);
    }
    if (link.value <= 0) {
      throw new Error(`Invalid value: ${link.value}`);
    }
  }
}
```

---

## 5. 今後の拡張可能性

### 5.1 追加可能な型

- `ProjectDetail`: プロジェクト詳細情報（ドリルダウン時のモーダル表示用）
- `FilterOptions`: 年度・会計区分などのフィルタ設定
- `ExportFormat`: CSV/Excel/PDF等のエクスポート形式

### 5.2 型定義の管理方針

- 型ファイルは`types/`ディレクトリに集約
- 各型に対応する仕様書セクションを本ドキュメントに追記
- 破壊的変更時はマイグレーションガイドを別途作成

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2025-11-18 | 初版作成 | Claude |
