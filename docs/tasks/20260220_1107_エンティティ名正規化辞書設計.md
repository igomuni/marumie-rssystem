# エンティティ名正規化辞書 設計ドキュメント

> Issue: #70 名前正規化によるoutflow代表企業判定の精度向上

---

## 目的

閲覧者が Sankey 図を見たときに、同一企業の表記ゆれ（支店・法人格違い等）でノードが分裂したり、
outflow の紐づけが誤ったりする状態を解消するため。

具体的には：

1. **outflow 代表企業判定の精度向上**（バグ修正）
   - 現状: `株式会社JTB` が `株式会社JTB埼玉支店ほか` のブロック outflow を誤って受け取る
   - 解決: 辞書ベースのマッチングで曖昧なサブストリング一致を補完

2. **表示名の正規化**（UX 改善）
   - 現状: `株式会社野村総合研究所` と `野村総合研究所` が同一企業なのに別名で表示される場合がある
   - 解決: displayName フィールドで法人格を除いた表示名を提供

3. **エンティティ種別の構造的管理**（分析基盤）
   - 現状: `SpendingTags.primaryCategory` はパターンベース推定で精度にムラがある
   - 解決: LLM が判定した authoritative な entityType を辞書に持ち、タグ付けの精度向上に活用

4. **支出先ブラウザ UI の提供**（新機能）
   - 辞書データそのものを閲覧・横断分析できる専用ページ（`/entities`）
   - MOF 予算全体ビューと同じ導線パターンで Top ページからアクセス
   - entityType 別の集計・検索・Sankey ページへのジャンプ

---

## 現状の問題

### 確認済みバグ: PID=3136 Block AE（JTB 誤判定）

```
ブロック名 "株式会社JTB埼玉支店ほか"
  → normalizeCompanyName() 後: "JTB埼玉支店"

支出先 "株式会社JTB埼玉支店" → "JTB埼玉支店" → includes → TRUE  ✓ 正しい
支出先 "株式会社JTB"         → "JTB"         → includes → TRUE  ✗ 誤検知
  （"JTB" が "JTB埼玉支店" のサブストリングになるため）
```

**根本原因**: `normalizeCompanyName()` が支店・支社サフィックスを除去しないため、
親会社名が支店名のサブストリングになってしまう。

### 副次的な問題: 名称バリエーション

CSV 調査 (5-1: 26,192 ユニーク企業名) で確認済みの正規化が必要なケース：
- 同一企業の法人格違い: `株式会社野村総合研究所` / `野村総合研究所`
- 後置き法人格: `IHI株式会社` / `株式会社IHI`
- 独立行政法人の表記揺れ: `独立行政法人情報処理推進機構` / `(独)自動車技術総合機構交通安全環境研究所`
- 支店名: `株式会社JTB埼玉支店`（5-2 ブロック名で 2 件確認）

---

## 設計概要

### アーキテクチャ

```
[LLM による事前生成]
    ↓
data/entity-normalization.json   ← ① 新規ファイル（辞書、Git 管理対象）
    ↓
scripts/generate-structured-json.ts   ← ② 辞書を参照
    ├─ outflow 代表企業マッチング（精度向上）
    └─ displayName / entityType を SpendingRecord に埋め込む
    ↓
public/data/rs2024-structured.json   ← ③ JSON に displayName / entityType が追加される
    ↓
app/lib/sankey-generator.ts / UI   ← ④ displayName を優先表示
```

### 関係するファイル

| ファイル | 変更内容 |
|---------|---------|
| `data/entity-normalization.json` | 新規作成（辞書本体） |
| `types/structured.ts` | `SpendingRecord` に `displayName?: string` / `entityType?: EntityType` 追加 |
| `scripts/generate-structured-json.ts` | 辞書ロード・マッチング改善・フィールド埋め込み |
| `app/lib/sankey-generator.ts` | displayName 優先表示への対応 |

---

## 辞書スキーマ設計

### ファイル形式

`data/entity-normalization.json`（フラット lookup テーブル）:

```
{
  "<CSV に現れる支出先名>": {
    "displayName": "<表示名>",
    "entityType": "<エンティティ種別>",
    "parentName"?: "<親会社の displayName>"   // 支店・支社の場合のみ
  },
  ...
}
```

### displayName ポリシー

- **法人格（前置き・後置き）を除去した正式名称**を基本とする
  - `株式会社野村総合研究所` → `野村総合研究所`
  - `独立行政法人情報処理推進機構` → `情報処理推進機構`
- ブランド名（NEC, NHK 等）への変換は**行わない**（政府公開データの文脈では正式商号を優先）
  - gBizINFO・法人番号公表サイトも正式商号を主表示としている
- 支店・支社名はそのまま残す（parentName で親を示す）
  - `株式会社JTB埼玉支店` → displayName: `JTB埼玉支店`、parentName: `JTB`

### entityType（粗め 6 分類）

| entityType | 対象 | 法人種別コード |
|-----------|------|--------------|
| `民間企業` | 株式会社・有限会社・合同会社等 | 301, 302, 303, 304, 305 |
| `地方公共団体` | 都道府県・市区町村・特別区等 | 201 |
| `国の機関` | 省庁・外局・裁判所・検察等 | 101 |
| `独立行政法人` | 独立行政法人・国立研究開発法人 | 399 の一部 |
| `公益法人・NPO` | 公益財団・公益社団・一般財団・一般社団・特定非営利等 | 399 の一部 |
| `外国法人` | 海外の企業・団体 | 401 |
| `その他` | 協議会・組合・個人・不明等 | 499, 空欄 |

### 既存 PrimaryCategory との関係

辞書の `entityType` は既存の `SpendingTags.primaryCategory` より詳細な分類であり、
次のように対応する（将来的に tag-classifier.ts がこれを参照できる）:

| entityType | PrimaryCategory |
|-----------|-----------------|
| 民間企業 / 外国法人 | `private` |
| 地方公共団体 / 国の機関 / 独立行政法人 | `government` |
| 公益法人・NPO | `public-interest` |
| その他 | `individual-other` |

---

## types/structured.ts への追加

`SpendingRecord` に以下を追加:

```
displayName?: string;     // 表示名（法人格除去済み）。未登録の場合 spendingName にフォールバック
entityType?: EntityType;  // エンティティ種別（辞書に登録された場合のみ）
parentName?: string;      // 支店等の場合の親会社 displayName
```

`EntityType` は以下の union type として `types/structured.ts` に追加:

```
export type EntityType =
  | '民間企業'
  | '地方公共団体'
  | '国の機関'
  | '独立行政法人'
  | '公益法人・NPO'
  | '外国法人'
  | 'その他';
```

---

## generate-structured-json.ts の変更

### outflow 代表企業マッチングの改善

現在のサブストリング一致を辞書ベースマッチングで補完:

```
現在:  normalizedSource.includes(normalizedRecord) || normalizedRecord.includes(normalizedSource)

改善後（優先順位）:
  1. 辞書 lookup: dict[spendingName]?.displayName === dict[sourceBlockName]?.displayName
     → 両方の正規名が一致すれば確定マッチ（偽陽性を防ぐ）
  2. fallback: 従来のサブストリング一致
```

### displayName / entityType の埋め込み

`buildSpendingRecords()` 内で SpendingRecord 構築時に辞書を参照し、
`displayName` / `entityType` / `parentName` をセットする。

---

## LLM 辞書生成の方針

### 生成対象のスコープ

全 26,192 ユニーク企業名を以下の優先度でバッチ処理:

| 優先度 | 対象 | 件数 | 理由 |
|-------|------|------|------|
| 高 | 法人種別 399（その他法人）| 4,198 | 独法/公益法人/JV 混在で自動分類困難 |
| 高 | 法人種別 空欄 かつ名前に `(株)` / `(一財)` 等あり | ~1,000 | 法人格情報が名前にのみ存在 |
| 中 | 法人種別 301/302/305（株式会社等）| 11,000+ | 支店判定・displayName 生成 |
| 低 | 法人種別 101/201/401 | ~1,500 | ルールベースで概ね判定可能 |

### バッチ処理

1. CSV から全ユニーク企業名を抽出（法人種別コードも付与）
2. 100〜200 件ずつバッチに分けて LLM API へ投げる
3. 出力: `{ "企業名": { "displayName": "...", "entityType": "...", "parentName"?: "..." } }` 形式
4. 人手レビュー後に `data/entity-normalization.json` にマージ・コミット

### LLM への入力形式（案）

```
以下の日本の政府支出データに登場する支出先名を正規化してください。
各エントリについて以下を判定してください：
- displayName: 法人格（株式会社等）を除いた表示名
- entityType: 民間企業 / 地方公共団体 / 国の機関 / 独立行政法人 / 公益法人・NPO / 外国法人 / その他
- parentName: 支店・支社の場合、親会社の displayName（不明な場合は省略）

入力:
[
  { "name": "株式会社JTB埼玉支店", "corporateType": "301" },
  { "name": "独立行政法人情報処理推進機構", "corporateType": "399" },
  ...
]
```

---

## 実装の進め方

1. **型定義追加** (`types/structured.ts`) — `EntityType` / `SpendingRecord` の拡張
2. **辞書生成スクリプト作成** (`scripts/generate-entity-normalization.ts`) — CSV からバッチ入力を生成
3. **LLM によるバッチ処理** — API 呼び出し → JSON 出力 → 人手レビュー
4. **辞書ファイルコミット** (`data/entity-normalization.json`)
5. **generate-structured-json.ts の更新** — 辞書ロード・マッチング改善・フィールド埋め込み
6. **sankey-generator.ts / UI の更新** — displayName 優先表示

---

## データ量の参考

| データ | 件数 |
|-------|------|
| 5-1 CSV 総行数 | 194,134 |
| ユニーク支出先名 | 26,192 |
| 支店・支社を含む名称（5-1） | 1,081 |
| 5-2 ブロック名に支店・支社あり | 2 件のみ（outflow マッチング影響範囲は限定的） |
| 複数バリエーションが存在する企業 | 151 社（確認済み） |

---

## 支出先ブラウザ UI（別ページ）

### 概要

辞書データが整備された後に、支出先の一覧・横断分析を行える専用ページを追加する。
MOF予算全体ビュー（`/mof-budget-overview`）と同じパターンで Top ページに導線を設ける。

### ルート

`/entities` （仮称）

### Top ページへの追加カード

```
🏢 支出先ブラウザ
2024年度の全支出先 26,192 件を種別・金額でブラウズ。
エンティティ種別（民間企業・地方公共団体・独立行政法人 等）ごとの
集計や検索が可能。
```

### ページの機能

| 機能 | 内容 |
|-----|------|
| 一覧表示 | 支出先を金額降順で一覧。displayName / entityType / totalSpendingAmount を表示 |
| entityType フィルタ | 6 分類のタブ or チップフィルタ |
| 検索 | displayName / spendingName のインクリメンタル検索 |
| 集計サマリ | entityType 別の支出総額・件数（円グラフ or 棒グラフ） |
| 詳細リンク | 各行クリックで Sankey ページの「支出先ビュー」にジャンプ |
| parentName | 支店エントリに「← JTB」のような親会社表示 |

### データソース

既存の `rs2024-structured.json` の `spendings` 配列から取得。
追加 API エンドポイントは不要（クライアントサイドフィルタリングで対応可能）。

### 実装の位置づけ

辞書データ (`data/entity-normalization.json`) と JSON 生成パイプラインの整備が前提。
`displayName` / `entityType` フィールドが `SpendingRecord` に入ってから着手する。
Sankey との段階的統合（entityType によるノード色分け等）は別 Issue として管理する。

---

## 制約・注意事項

- `data/entity-normalization.json` は Git 管理対象（`public/data/` 配下の大容量 JSON とは異なる）
- LLM 生成後は必ず人手レビューを行う（特に `parentName` の正確性）
- 辞書に登録されていない名称は従来の動作（サブストリング一致 + spendingName 直接表示）にフォールバックするため、段階的な整備が可能
- `tag-classifier.ts` の `primaryCategory` 判定には本辞書を即座に組み込まない（別 Issue として管理）
