# 支出先タグ分類システム設計

**作成日**: 2026-02-21
**ステータス**: レビュー待ち

---

## 目的

支出先ブラウザ（`/entities`）の分類精度・粒度を高めるため、現在の7分類（単一値）を拡張し、
タグ付け方式（複数値許容）の新分類体系を設計する。

- ビュアーが都道府県・府省庁・国立大学法人などを個別にフィルタリングできるようになる
- 名前ベースの確実な分類を先行実装することで、LLMへの依存度を下げる

---

## 現状

### 既存の EntityType（7種）

```
'民間企業' | '地方公共団体' | '国の機関' | '独立行政法人'
| '公益法人・NPO' | '外国法人' | 'その他'
```

- **単一値**: SpendingRecord.entityType は 1 つだけ
- **entity-normalization.json**: `{ displayName, entityType, parentName? }` の単一フィールド
- **分類方法**: ルールベース → LLM の 2段階

---

## 設計方針

### 1. タグ配列型への移行

`entityType: string` → `entityTags: string[]`

複数タグを許容する。基本的に 1〜2 件。将来的に「民間企業かつ外国法人」等の複合分類も可能にする。

### 2. 名前ベース優先

今回のスコープでは **法人番号（CN）に依存しない** 分類ルールを実装する。
CNパターン（`X000012XXXXXX` 等）は将来の強化として別途検討。

### 3. 分類の確度を優先順位で管理

| 優先度 | 手法 | 確度 |
|---|---|---|
| 1 | 完全一致リスト（DBファイル） | 確実 |
| 2 | プレフィックス一致（DBファイル） | 高 |
| 3 | サフィックスパターン（DBファイル） | 高 |
| 4 | キーワード含有 | 中 |
| 5 | CSVコード（法人種別） | 中（399は除外） |
| 6 | LLM推定 | 中 |

### 4. 判定基準（データ）と判定処理（スクリプト）の分離

分類ルールをスクリプトにハードコードせず、**分類DBファイル（JSON）** として外部管理する。

- 国リストや府省庁リストの追加・修正 → JSONファイルの編集のみで完結
- スクリプト（`generate-entity-dict.ts`）は DBファイルを読み込んで分類処理を実行

---

## 新タグ定義

### EntityTag 型（新規）

既存の `EntityType` を `EntityTag` に改名・拡張する。

```
// 地方公共団体系（細分化）
'都道府県'            ← NEW
'市区町村'            ← NEW（市・区・町・村）
'地方公共団体'        ← 既存（上記以外の地方公共団体機関：県警察・水道局等）

// 国の機関系（細分化）
'府省庁'              ← NEW
'国の機関'            ← 既存（府省庁以外の出先機関：農政局・財務局等）

// 法人格系（細分化）
'国立大学法人'        ← NEW
'公立大学法人'        ← NEW
'学校法人'            ← NEW（学校法人早稲田大学 等）
'独立行政法人'        ← 既存（大学以外の独法・国研）
'一般社団法人'        ← NEW
'公益社団法人'        ← NEW
'一般財団法人'        ← NEW
'公益財団法人'        ← NEW
'特定非営利活動法人'  ← NEW（NPO法人プレフィックスも同タグに集約）
'公益法人・NPO'       ← 既存（上記以外のNPO・協同組合等）
'民間企業'            ← 既存

// 国家
'国'                  ← NEW（外国の国家名：アメリカ合衆国・ウクライナ等）

// その他
'外国法人'            ← 既存
'その他'              ← 既存
```

---

## 分類データベース設計

### ディレクトリ構成

```
scripts/
  classification-db/
    prefectures.json      # 都道府県リスト（完全一致）
    ministries.json       # 府省庁リスト（完全一致）
    countries.json        # 国名リスト（完全一致 + バリエーション）
    prefix-rules.json     # 法人格プレフィックスルール
    suffix-rules.json     # サフィックスパターンルール（市区町村等）
```

これらのファイルは `scripts/` 配下に置き、Gitで管理する（データパイプラインの設定として扱う）。

### prefectures.json

```json
["北海道", "青森県", "岩手県", "宮城県", "秋田県", "山形県", "福島県",
 "茨城県", "栃木県", "群馬県", "埼玉県", "千葉県", "東京都", "神奈川県",
 "新潟県", "富山県", "石川県", "福井県", "山梨県", "長野県", "岐阜県",
 "静岡県", "愛知県", "三重県", "滋賀県", "京都府", "大阪府", "兵庫県",
 "奈良県", "和歌山県", "鳥取県", "島根県", "岡山県", "広島県", "山口県",
 "徳島県", "香川県", "愛媛県", "高知県", "福岡県", "佐賀県", "長崎県",
 "熊本県", "大分県", "宮崎県", "鹿児島県", "沖縄県"]
```

### ministries.json

府省庁の完全一致リスト。

```json
[
  "内閣府", "内閣官房", "内閣法制局",
  "総務省", "法務省", "外務省", "財務省",
  "文部科学省", "厚生労働省", "農林水産省",
  "経済産業省", "国土交通省", "環境省", "防衛省",
  "金融庁", "消費者庁", "こども家庭庁", "デジタル庁", "復興庁",
  "警察庁", "宮内庁", "国税庁", "文化庁", "スポーツ庁",
  "林野庁", "水産庁", "中小企業庁", "特許庁", "気象庁",
  "海上保安庁", "観光庁", "資源エネルギー庁",
  "原子力規制委員会", "公正取引委員会", "国家公安委員会", "人事院"
]
```

- 農林水産省近畿農政局 は不一致 → `国の機関` に分類
- 将来の追加は JSON 編集のみで完結

### countries.json

国名の正式名称と表記バリエーション（エイリアス）を管理。

```json
[
  {
    "primaryName": "アメリカ合衆国",
    "tags": ["国"],
    "aliases": ["アメリカ", "米国", "米", "合衆国", "亜米利加"]
  },
  {
    "primaryName": "グレートブリテン及び北アイルランド連合王国",
    "tags": ["国"],
    "aliases": ["イギリス", "英国", "英", "UK"]
  },
  {
    "primaryName": "中華人民共和国",
    "tags": ["国"],
    "aliases": ["中国", "中", "中華"]
  },
  {
    "primaryName": "フランス共和国",
    "tags": ["国"],
    "aliases": ["フランス", "仏国", "仏"]
  },
  {
    "primaryName": "ドイツ連邦共和国",
    "tags": ["国"],
    "aliases": ["ドイツ", "独", "独逸"]
  },
  {
    "primaryName": "ロシア連邦",
    "tags": ["国"],
    "aliases": ["ロシア", "露国", "露"]
  },
  {
    "primaryName": "大韓民国",
    "tags": ["国"],
    "aliases": ["韓国", "韓"]
  },
  {
    "primaryName": "ウクライナ",
    "tags": ["国"],
    "aliases": []
  },
  {
    "primaryName": "フィリピン共和国",
    "tags": ["国"],
    "aliases": ["フィリピン", "比国", "比"]
  },
  {
    "primaryName": "マダガスカル共和国",
    "tags": ["国"],
    "aliases": ["マダガスカル"]
  },
  {
    "primaryName": "カンボジア王国",
    "tags": ["国"],
    "aliases": ["カンボジア"]
  },
  {
    "primaryName": "パキスタン・イスラム共和国",
    "tags": ["国"],
    "aliases": ["パキスタン"]
  },
  {
    "primaryName": "アフガニスタン・イスラム共和国",
    "tags": ["国"],
    "aliases": ["アフガニスタン"]
  },
  {
    "primaryName": "モザンビーク共和国",
    "tags": ["国"],
    "aliases": ["モザンビーク"]
  }
  // ... 国連加盟193カ国 + 主要地域を網羅予定
]
```

**マッチング方針**: `primaryName` と `aliases` の両方を完全一致検索対象とする。

### prefix-rules.json

法人格プレフィックスとタグのマッピング。複数プレフィックスが同一タグに集約されるケースもある。

```json
[
  { "prefix": "国立大学法人",     "tags": ["国立大学法人"] },
  { "prefix": "公立大学法人",     "tags": ["公立大学法人"] },
  { "prefix": "学校法人",         "tags": ["学校法人"] },
  { "prefix": "独立行政法人",     "tags": ["独立行政法人"] },
  { "prefix": "国立研究開発法人", "tags": ["独立行政法人"] },
  { "prefix": "(独)",             "tags": ["独立行政法人"] },
  { "prefix": "(国研)",           "tags": ["独立行政法人"] },
  { "prefix": "一般社団法人",     "tags": ["一般社団法人"] },
  { "prefix": "公益社団法人",     "tags": ["公益社団法人"] },
  { "prefix": "一般財団法人",     "tags": ["一般財団法人"] },
  { "prefix": "公益財団法人",     "tags": ["公益財団法人"] },
  { "prefix": "特定非営利活動法人", "tags": ["特定非営利活動法人"] },
  { "prefix": "NPO法人",          "tags": ["特定非営利活動法人"] }
]
```

### suffix-rules.json

サフィックスパターンによる分類ルール。

```json
[
  {
    "suffixes": ["市", "区", "町", "村"],
    "tags": ["市区町村"],
    "excludePatterns": ["組合", "連合会", "会議", "協会", "協議会", "センター"]
  }
]
```

---

## 分類ルール設計（今回スコープ）

スクリプトは `classification-db/` を読み込み、以下の順序で判定する。

### ルール1: 完全一致 → 都道府県

`prefectures.json` を参照。47件の完全一致のみ。

- タグ: `['都道府県']`
- 現状の `'地方公共団体'` から昇格

### ルール2: 完全一致 → 府省庁

`ministries.json` を参照。

- 上記の完全一致のみ（`農林水産省近畿農政局` は不一致 → ルール5で国の機関）
- タグ: `['府省庁']`
- 現状の `'国の機関'` から昇格

### ルール3: 完全一致 → 国（外国の国家名）

`countries.json` の `primaryName` および `aliases` を参照。

- タグ: `['国']`
- CSVに登場する8カ国（アメリカ合衆国、ウクライナ、フィリピン、マダガスカル、カンボジア、パキスタン、アフガニスタン、モザンビーク）を初期登録済み
- 将来のCSVデータ更新時は `countries.json` に追記するだけで対応

### ルール4: サフィックスパターン → 市区町村

`suffix-rules.json` を参照。

- 名前末尾が「市」「区」「町」「村」かつ `excludePatterns` に該当しない
- タグ: `['市区町村']`
- CSVでの対象件数: 約1,224件

### ルール5〜13: プレフィックス一致 → 各法人格

`prefix-rules.json` を参照。

| プレフィックス | タグ | 例 |
|---|---|---|
| `国立大学法人` | `'国立大学法人'` | 国立大学法人東京大学 |
| `公立大学法人` | `'公立大学法人'` | 公立大学法人大阪 |
| `学校法人` | `'学校法人'` | 学校法人早稲田大学 |
| `独立行政法人` | `'独立行政法人'` | 独立行政法人日本学術振興会 |
| `国立研究開発法人` | `'独立行政法人'` | （同タグ） |
| `(独)`, `(国研)` | `'独立行政法人'` | 略称プレフィックス |
| `一般社団法人` | `'一般社団法人'` | 一般社団法人日本経済団体連合会 |
| `公益社団法人` | `'公益社団法人'` | 公益社団法人日本医師会 |
| `一般財団法人` | `'一般財団法人'` | 一般財団法人地方経済総合研究所 |
| `公益財団法人` | `'公益財団法人'` | 公益財団法人日本財団 |
| `特定非営利活動法人` | `'特定非営利活動法人'` | 特定非営利活動法人コード・フォー・ジャパン |
| `NPO法人` | `'特定非営利活動法人'` | NPO法人○○ |

---

## スキーマ変更

### entity-normalization.json（辞書ファイル）

**変更前**:
```json
{
  "北海道農政事務所": {
    "displayName": "北海道農政事務所",
    "entityType": "国の機関"
  }
}
```

**変更後**:
```json
{
  "北海道農政事務所": {
    "displayName": "北海道農政事務所",
    "entityTags": ["国の機関"]
  }
}
```

- `entityType: string` → `entityTags: string[]`
- `parentName?` は変更なし

### types/structured.ts

```typescript
// 変更前
export type EntityType = '民間企業' | '地方公共団体' | ... ;
export interface SpendingRecord {
  entityType?: EntityType;
}

// 変更後
export type EntityTag =
  | '都道府県' | '市区町村' | '地方公共団体'
  | '府省庁' | '国の機関'
  | '国立大学法人' | '公立大学法人' | '学校法人' | '独立行政法人'
  | '一般社団法人' | '公益社団法人'
  | '一般財団法人' | '公益財団法人'
  | '特定非営利活動法人' | '公益法人・NPO'
  | '民間企業' | '国' | '外国法人' | 'その他';

export interface SpendingRecord {
  entityTags?: EntityTag[];  // 配列・省略可（辞書未登録）
}
```

---

## 影響ファイル一覧

| ファイル | 変更内容 |
|---|---|
| `scripts/classification-db/prefectures.json` | **新規作成**: 都道府県リスト |
| `scripts/classification-db/ministries.json` | **新規作成**: 府省庁リスト |
| `scripts/classification-db/countries.json` | **新規作成**: 国名リスト（aliases含む） |
| `scripts/classification-db/prefix-rules.json` | **新規作成**: 法人格プレフィックスルール |
| `scripts/classification-db/suffix-rules.json` | **新規作成**: サフィックスパターンルール |
| `types/structured.ts` | `EntityType` → `EntityTag`、`SpendingRecord.entityType` → `entityTags: EntityTag[]` |
| `scripts/generate-entity-dict.ts` | DBファイル読み込みロジックに刷新、出力フォーマット変更（entityType → entityTags） |
| `scripts/generate-structured-json.ts` | `dictEntry.entityType` → `dictEntry.entityTags` 参照変更 |
| `app/api/entities/route.ts` | `EntityListItem.entityType` → `entityTags`、フィルタリングロジック変更 |
| `app/entities/page.tsx` | フィルタUI・バッジ・統計グラフの表示ロジック変更 |
| `public/data/entity-normalization.json` | 全エントリの `entityType` → `entityTags` マイグレーション |
| `public/data/rs2024-structured.json.gz` | 再生成（`npm run generate-structured` → `compress-data`） |

---

## 今回スコープ外（将来検討）

- 法人番号（CN）パターンによる分類（`X000012XXXXXX`=国の機関、`X000020XXXXXX`=地方公共団体）
- `国際機関` タグの追加（国連機関・条約機関等を `外国法人` から分離）
- 市区町村の完全一致リスト整備
- UIでのタグ複数選択フィルタの詳細UX設計
- 府省庁リストの網羅性確認（現在36件、CSVに登場済みは29件）

---

## 未解決の確認事項

1. **`EntityType` → `EntityTag` のリネーム**: 既存の型名を変更するか、`EntityType` を `EntityTag[]` のエイリアスとして残すか
2. **`市区町村` サフィックスの例外処理**: `excludePatterns` のリストをどこまで整備するか
3. **LLMプロンプトの更新**: 新タグ体系に合わせてLLMへの分類指示を更新が必要
4. **`開発法人`**: ご指摘の「開発法人」が指す法人格の種類を確認。`一般財団法人` として扱うか、別途キーワードルールを設けるか
5. **`countries.json` の初期収録範囲**: CSVに登場する8カ国のみ（最小限）か、国連加盟193カ国を全収録するか（将来の追加が不要になる）
