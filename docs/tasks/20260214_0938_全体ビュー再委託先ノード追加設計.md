# 全体ビュー 再委託先ノード追加設計

**作成日**: 2026年2月14日
**対象ビュー**: `/sankey` の全体ビュー（`mode === 'global'`）

---

## 1. Why（目的）

現在、再委託先の情報は**支出先ビュー**（特定の支出先を選択した後）でのみ確認できる。

全体ビューでは「政府 → 府省庁 → 事業 → 支出先」までしか表示されず、支出先がさらにどこに委託しているかが分からない。

全体ビューに再委託先ノードを追加することで、**予算全体のフローを最後の委託先まで一気通貫で把握**できるようになる。

```
現在の全体ビュー:
  予算総計 → 府省庁(TopN) → 事業(予算) → 事業(支出) → 支出先(TopN)

目標:
  予算総計 → 府省庁(TopN) → 事業(予算) → 事業(支出) → 支出先(TopN) → 再委託先(TopN)
```

---

## 2. 現状分析

### 既存実装（支出先ビュー）
- `SpendingRecord.outflows?: SpendingBlockFlow[]` に再委託フロー情報が格納済み
- `SpendingBlockFlow.amount` に金額あり
- `subcontract-recipient` ノードタイプ定義済み
- 支出先ビュー（`targetRecipientName` 設定時）で再委託先表示ロジック実装済み（`sankey-generator.ts:1015-1193`）

### 全体ビューで未対応な点
- 全体ビューのAPI呼び出しに `subcontractLimit` パラメータが渡されていない
- `sankey-generator.ts` の全体ビュー分岐（`isGlobalView`）に再委託先ノード生成ロジックがない
- `app/sankey/page.tsx` のTopN設定パネルに全体ビュー用の再委託先設定がない

---

## 3. データ設計

### 集約方法: グローバル集約
全TopN支出先のoutflowsを横断して、**同名の再委託先は合算**する。

**例:**
- 博報堂 → 東京電力EP: 1.90兆円
- 博報堂 → 東京ガス: 0.43兆円
- 別の支出先 → 東京電力EP: 0.10兆円
→ 再委託先ノード「東京電力EP等」= 2.00兆円（合算）

**理由**: ノード数を抑えて視認性を確保するため。個別のフローは詳細ダイアログで表示する。

### 表示対象
- `topSpendings`（全体ビューで選択されたTopN支出先）のoutflowsすべてを使用
- 「その他の支出先」と「その他」ノードのoutflowsは除外（集計が困難なため）

### TopN設定
- デフォルト: 5（`subcontractLimit` パラメータ）
- TopN以外は「その他の再委託先」ノードに集約

---

## 4. 修正ファイル一覧

| ファイル | 変更内容 | 規模 |
|---------|---------|------|
| `app/lib/sankey-generator.ts` | 全体ビューの isGlobalView 分岐に再委託先集約ロジックを追加 | 中 |
| `app/api/sankey/route.ts` | `subcontractLimit` / `showSubcontracts` パラメータをグローバルビューでも受け取る | 小 |
| `app/sankey/page.tsx` | グローバルビューAPIコールに `subcontractLimit` 追加 + TopN設定UI更新 | 小 |

---

## 5. 実装詳細

### 5.1 `sankey-generator.ts` の変更

**場所**: 全体ビューの支出先ノード作成後（約 `line 2270` 以降）

```typescript
// Global View: 再委託先ノードを追加
if (isGlobalView && !targetMinistryName && !targetProjectName) {
  const globalSubcontractAgg = new Map<string, {
    name: string;
    totalAmount: number;
    sources: string[]; // 委託元の支出先名リスト
    flowTypes: Set<string>;
  }>();

  // topSpendings の outflows を集約
  for (const spending of topSpendings) {
    const fullSpending = fullData.spendings.find(
      (s: SpendingRecord) => s.spendingId === spending.spendingId
    );
    if (!fullSpending?.outflows) continue;

    for (const flow of fullSpending.outflows) {
      const key = flow.targetBlockName;
      if (!globalSubcontractAgg.has(key)) {
        globalSubcontractAgg.set(key, {
          name: flow.targetBlockName,
          totalAmount: 0,
          sources: [],
          flowTypes: new Set(),
        });
      }
      const agg = globalSubcontractAgg.get(key)!;
      agg.totalAmount += flow.amount;
      if (!agg.sources.includes(spending.spendingName)) {
        agg.sources.push(spending.spendingName);
      }
      agg.flowTypes.add(flow.flowType || '再委託');
    }
  }

  // 金額でソートしてTopN選択
  const sorted = Array.from(globalSubcontractAgg.entries())
    .sort((a, b) => b[1].totalAmount - a[1].totalAmount);

  const effectiveSubcontractLimit = subcontractLimit ?? 5;
  const topSubcontracts = sorted.slice(0, effectiveSubcontractLimit);
  const otherSubcontracts = sorted.slice(effectiveSubcontractLimit);

  // TopN 再委託先ノード作成
  for (const [, data] of topSubcontracts) {
    const nodeId = `subcontract-global-${data.name}`;
    nodes.push({
      id: nodeId,
      name: data.name,
      type: 'subcontract-recipient',
      value: data.totalAmount,
      details: {
        corporateNumber: '',
        location: '',
        projectCount: data.sources.length,
        // sourceRecipient: data.sources を使ってツールチップに委託元を表示
      },
    });

    // リンク: 各委託元支出先 → 再委託先
    for (const spending of topSpendings) {
      const fullSpending = fullData.spendings.find(
        (s: SpendingRecord) => s.spendingId === spending.spendingId
      );
      if (!fullSpending?.outflows) continue;

      const totalToThisSubcontract = fullSpending.outflows
        .filter(f => f.targetBlockName === data.name)
        .reduce((sum, f) => sum + f.amount, 0);

      if (totalToThisSubcontract > 0) {
        links.push({
          source: `recipient-${spending.spendingId}`,
          target: nodeId,
          value: totalToThisSubcontract,
        });
      }
    }
  }

  // 「その他の再委託先」集約ノード
  if (otherSubcontracts.length > 0) {
    const otherTotal = otherSubcontracts.reduce(
      (sum, [, data]) => sum + data.totalAmount, 0
    );
    if (otherTotal > 0) {
      // ... （支出先ビューの実装と同様）
    }
  }
}
```

### 5.2 `app/api/sankey/route.ts` の変更

```typescript
// GET パラメータ受け取りに追加
const subcontractLimitParam = searchParams.get('subcontractLimit');
const subcontractLimit = subcontractLimitParam ? parseInt(subcontractLimitParam) : 5;

// generateSankeyData に渡す
const result = generateSankeyData({
  ...,
  subcontractLimit, // 全体ビューでも渡す
});
```

### 5.3 `app/sankey/page.tsx` の変更

**APIコール部分:**
```typescript
if (viewState.mode === 'global') {
  params.set('limit', topNSettings.global.ministry.toString());
  params.set('projectLimit', '3');
  params.set('spendingLimit', topNSettings.global.spending.toString());
  params.set('subcontractLimit', topNSettings.global.subcontract.toString()); // 追加
  ...
}
```

**TopN設定の型拡張:**
```typescript
// topNSettings.global に subcontract フィールドを追加
const [topNSettings, setTopNSettings] = useState({
  global: {
    ministry: 3,
    spending: 5,
    subcontract: 5, // 追加
  },
  ...
});
```

**設定UIパネル（全体ビュー設定に追加）:**
```tsx
<label>再委託先 TopN:</label>
<input
  type="number"
  min={1} max={20}
  value={tempTopNSettings.global.subcontract}
  onChange={(e) => setTempTopNSettings(prev => ({
    ...prev,
    global: { ...prev.global, subcontract: parseInt(e.target.value) || 1 }
  }))}
/>
```

---

## 6. 確認ポイント

- [ ] 全体ビューに再委託先カラムが表示される
- [ ] 再委託先ノードの金額が正しい（支出先ビューとの比較検証）
- [ ] 「その他の再委託先」ノードが正しく集約される
- [ ] TopN設定パネルで再委託先数を変更できる
- [ ] 再委託先ノードをクリックすると詳細ダイアログが開く
- [ ] ラベル表示が乱れない（6列目のため右側margin確認）
- [ ] `npm run build` がエラーなく通る

---

## 7. リスク評価

| リスク | 可能性 | 対策 |
|--------|--------|------|
| ノード過多で図が見づらくなる | 中 | TopN=5に制限、その他は集約 |
| 右側ラベルが画面外に出る | 中 | margin-right を拡大（200px → 250px以上） |
| outflows が空のケースの多さ（データ未整備） | 中 | 再委託先0件の場合はカラム非表示 |
| 金額集約の誤差 | 低 | 既存の支出先ビューロジックを流用 |

---

## 8. 検証方法

```bash
npm run dev
# /sankey を開く
# 全体ビューの最右列（支出先）の右に再委託先カラムが追加されていることを確認
# 経済産業省 → 電気・ガス価格激変緩和対策事業 → 博報堂 の右に
# 東京電力EP等、東京ガス等が表示されることを確認
```

---

## 9. 未解決の検討事項

1. **再委託先が0件の場合の挙動**: 全topSpendingsにoutflowsが空の場合、6列目を非表示にすべきか
2. **ドリルダウン時の再委託先**: 支出先drilldownLevel変更時も再委託先を更新するか
3. **topNSettings.global.subcontract の永続化**: URLパラメータに含めるか

