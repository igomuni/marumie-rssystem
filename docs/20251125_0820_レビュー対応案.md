# レビュー対応案

## 元レビュー
`docs/20251121_1600_レビュー.md` を参照

## 対応方針

### ✅ 対応する項目

#### 1. 個別のviewに対してpermalinkを振る
**要望**: ブラウザで戻ると位置をロストしてしまう。人にviewを共有できない

**対応案**:
- URLにビューの状態を反映
- 例:
  - グローバルビュー: `/sankey`
  - 府省庁ビュー: `/sankey?ministry=厚生労働省`
  - 事業ビュー: `/sankey?project=基礎年金給付に必要な経費`
  - 支出ビュー: `/sankey?recipient=年金受給者`
- ブラウザの戻る/進むボタンで履歴をたどれるようにする
- URLをコピーして他の人に共有可能

**実装方法**:
- `useRouter`と`useSearchParams`を使用
- ビュー切り替え時に`router.push()`でURLを更新
- 初期ロード時にクエリパラメータからビューを復元

**優先度**: 🔴 高（UX改善に直結）

---

#### 2. 支出先のビューのお金の流れを左から右に統一
**要望**: 支出先のビューだけお金の流れが逆になっているので理解がしにくい

**現状**:
- 支出ビュー: 支出先（左）→ 事業（中央）→ 府省庁（右）
- これは予算の流れ（左→右）と逆向き

**対応案A（推奨）**: レイアウトを反転
- サンキー図のノード配置を反転して表示
- 府省庁（左）→ 事業（中央）→ 支出先（右）に変更
- データフローは変えず、表示だけ反転

**対応案B**: データフローを反転
- APIレスポンスのリンク方向を逆にする
- より根本的な変更が必要

**推奨**: 対応案A
- 実装が簡単（CSSやNivoの設定で対応可能）
- データ処理ロジックを変更しなくて良い

**優先度**: 🔴 高（UX改善に直結）

---

#### 3. 事業のメタデータへのリンク
**要望**: 個別の事業の硬いファクトのページに飛びたい。元のRSシステムのページなどに飛べるだけでも意味がありそう

**対応案**:
- ノードにツールチップを表示
- ツールチップ内に「詳細を見る」リンクを追加
- リンク先: 行政事業レビューシステムの該当ページ
  - 例: `https://rssystem.go.jp/project/{year}/{projectId}`

**必要なデータ**:
- `rs2024-structured.json` にプロジェクトIDが含まれているか確認
- 含まれていない場合、CSVから取得して追加

**実装方法**:
- Nivoサンキー図の `nodeTooltip` プロパティを使用
- ツールチップにリンクボタンを追加

**優先度**: 🟡 中（便利だが必須ではない）

---

#### 4. サンキーのストリームと縦幅の大きさの食い違い
**要望**: ストリームの幅とノードの高さが一致していないケースがある

**原因**:
- Nivoサンキー図のレンダリングロジックの問題
- 複数のリンクが同じノードに集まる場合に発生しやすい

**対応案**:
- Nivoサンキー図の設定を調整
  - `nodeThickness` を調整
  - `nodePaddingRatio` を調整
  - `nodeSpacing` を調整
- レイアウトアルゴリズムの変更
  - `align` プロパティを調整（'justify', 'center', 'start', 'end'）

**実装方法**:
1. 現状のパラメータを確認
2. 各種設定値を試行錯誤で調整
3. 最適な値を見つける

**優先度**: 🟡 中（見た目の改善）

---

#### 5. その他を各レイヤー一つにまとめる
**要望**: 厚労省のその他と財務省のその他がまとまっていてもそんなに違和感がない

**現状**:
- 各府省庁・事業ごとに「その他」ノードが存在
- 「その他」（支出先名が「その他」）
- 「その他の支出先」（TopN以外）

**対応案**:
- 各レイヤーで「その他」系のノードを1つに統合
  - 事業レイヤー: すべての府省庁の「その他事業」を統合
  - 支出レイヤー: すべての「その他」と「その他の支出先」を統合

**メリット**:
- 見た目がシンプルになる
- 「その他」が多すぎて混乱することがなくなる

**デメリット**:
- どの府省庁の「その他」なのか分からなくなる
- ドリルダウンの意味が薄れる

**推奨**: 段階的に実装
1. まず「その他」と「その他の支出先」を統合（名前の問題を解決）
2. その後、レイヤーごとの統合を検討

**優先度**: 🟡 中（見た目の改善）

---

#### 6. 縦の順を大きさでdescendingでsort
**要望**: ノードが金額の降順にソートされているとわかりやすい。ただしその他は別扱い（一番下）

**対応案**:
- サンキー図生成ロジックでノードをソート
  1. 金額の降順でソート
  2. 「その他」系のノードを最後に配置

**実装方法**:
- `app/lib/sankey-generator.ts` でノード配列をソート
- ソート順を維持したままサンキー図データを生成

**優先度**: 🟢 低（あると便利だが必須ではない）

---

### 📋 検討項目

#### 7. 「上位xx%の支出を予算を除いたビュー」でフィルタ
**仮説**: 厚労省の年金部分を除いたビューを見たくなる

**対応案**:
- フィルタ機能を追加
  - 「特定の府省庁を除外」チェックボックス
  - 「特定の事業を除外」チェックボックス
- 除外リスト:
  - デフォルト: なし
  - プリセット: 「厚労省の年金関連事業」など

**実装の複雑さ**:
- UIコンポーネントの追加
- フィルタロジックの実装
- URLパラメータでの状態管理

**優先度**: 🟢 低（将来的な機能拡張として検討）

---

#### 8. 「その他事業者」「その他」「その他の支出先」の名前
**質問**: 区別した方がよさそうか、まとめてもいいか

**現状の定義**:
- 「その他」: 元データの支出先名が「その他」と記載されているもの
- 「その他の支出先」: TopNと「その他」以外のもの

**対応案**:
- より分かりやすい名前に変更
  - 「その他（詳細不明）」: 元データが「その他」
  - 「その他の支出先」: TopN以外
- または統合
  - 単に「その他」に統合

**推奨**: 名前を変更して区別を明確にする
- 「その他（元データ）」
- 「その他の支出先（TopN外）」

**優先度**: 🟡 中（理解しやすさに影響）

---

## 実装優先順位

### Phase 1: 高優先度（必須）
1. ✅ **Permalink対応** - URL状態管理
2. ✅ **支出ビューの流れ統一** - レイアウト反転

### Phase 2: 中優先度（推奨）
3. 🔶 **「その他」系の名前変更** - 理解しやすさ向上
4. 🔶 **事業メタデータへのリンク** - RSシステムへのリンク
5. 🔶 **サンキーのストリーム幅調整** - 見た目の改善

### Phase 3: 低優先度（将来的に検討）
6. ⬜ **ノードの金額順ソート**
7. ⬜ **レイヤーごとの「その他」統合**
8. ⬜ **除外フィルタ機能**

---

## 技術的な検討事項

### Permalink実装
- **使用技術**: Next.js App Router の `useRouter`, `useSearchParams`
- **考慮点**:
  - 初期ロード時のクエリパラメータ解析
  - ブラウザ履歴の管理
  - 共有URL生成

### 支出ビュー反転
- **方法1**: Nivoサンキー図の `layout` プロパティ
- **方法2**: CSSで反転（`transform: scaleX(-1)`）
- **推奨**: 方法1（ノードのテキストも正しく表示される）

### RSシステムへのリンク
- **URL形式調査が必要**
  - 実際のRSシステムのURL構造を確認
  - プロジェクトIDのマッピング
- **データ拡張**
  - `rs2024-structured.json` に `projectId` フィールド追加

---

## 次のステップ

1. Phase 1の2つの機能を実装
2. 動作確認
3. Phase 2の機能を順次実装
4. ユーザーフィードバックを収集
5. Phase 3の機能を検討
