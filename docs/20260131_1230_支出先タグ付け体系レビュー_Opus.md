# 支出先タグ付け体系の提案 - Opusレビュー

**レビュー日**: 2026年1月31日 12:30
**レビュー対象**: `docs/20260131_1115_支出先タグ付け体系の提案.md`
**レビュアー**: Claude Opus 4.5
**総合評価**: **良好（実装推奨）** - 基本設計は堅実だが、いくつかの改善点あり

---

## 1. 全体評価

### 1.1 優れている点

1. **段階的な実装アプローチ**: Phase 1〜4の分割は現実的で、早期に効果を確認できる設計
2. **データ分析に基づく設計**: 12,869件の実データ分析から課題を抽出しており、根拠が明確
3. **既存コードベースとの整合性**: `types/structured.ts`への追加という非破壊的な拡張
4. **ベンダーロックイン調査との連携**: 調査フローとリスク評価タグが一貫している

### 1.2 改善が必要な点

| 項目 | 重要度 | 理由 |
|------|--------|------|
| 名前パターン判定の順序 | 高 | 誤判定のリスク |
| 業種タグの排他性 | 中 | 複数タグ時の優先度不明確 |
| パフォーマンス考慮 | 中 | 正規表現の事前コンパイル |
| テスト戦略 | 高 | タグ判定ロジックの検証方法が未定義 |
| 国際化対応 | 低 | 英語名企業（AWS等）の判定 |

---

## 2. 設計上の問題点と修正案

### 2.1 【高】名前パターン判定の順序問題

**問題**: `detectOrganizationType`関数で、corporateTypeチェックと名前パターンチェックの順序が不適切なケースがある。

```typescript
// 現在のコード（問題あり）
if (corporateType === '301' || /株式会社/.test(name)) {
  // 301の中にも行政組織が混じっているので名前で再判定
  if (/地方整備局$|農政局$|森林管理局$/.test(name)) {
    return { primaryCategory: 'government', ... };
  }
  return { primaryCategory: 'private', ... };
}
```

**問題点**:
- `corporateType === '301'`だが名前に「株式会社」を含まない行政組織（例: 「九州地方整備局」）が、このif文の最初の条件でマッチし、その後の再判定でgovernmentになる。これは正しい動作。
- しかし、`corporateType !== '301'`で名前に「株式会社」を含む企業が、このif文に入ってこない可能性がある（実際は稀だが）。

**修正案**: 名前パターンを先に評価し、corporateTypeは補助的に使用する。

```typescript
function detectOrganizationType(
  name: string,
  corporateType: string
): { primaryCategory: PrimaryCategory; secondaryCategory: string } {

  // ========================================
  // 優先度1: 名前パターンで確実に判定できるもの（最優先）
  // ========================================

  // 地方整備局等（301に混入しているものも含む）
  if (/地方整備局$|農政局$|森林管理局$|経済産業局$|財務局$/.test(name)) {
    return {
      primaryCategory: 'government',
      secondaryCategory: '地方整備局等'
    };
  }

  // 労働局
  if (/労働局$/.test(name)) {
    return {
      primaryCategory: 'government',
      secondaryCategory: '労働局'
    };
  }

  // 防衛局
  if (/防衛局$/.test(name)) {
    return {
      primaryCategory: 'government',
      secondaryCategory: '国の機関'
    };
  }

  // 省庁（「〜省」で終わる）
  if (/省$/.test(name) && !/(株式会社|有限会社|合同会社)/.test(name)) {
    return {
      primaryCategory: 'government',
      secondaryCategory: '国の機関'
    };
  }

  // ========================================
  // 優先度2: 法人格表示で判定
  // ========================================

  // 国立研究開発法人（名前に明示されている）
  if (/国立研究開発法人/.test(name)) {
    return {
      primaryCategory: 'public-interest',
      secondaryCategory: '国立研究開発法人'
    };
  }

  // 独立行政法人
  if (/独立行政法人/.test(name)) {
    return {
      primaryCategory: 'public-interest',
      secondaryCategory: '独立行政法人'
    };
  }

  // 一般社団・財団法人
  if (/一般社団法人|一般財団法人/.test(name)) {
    return {
      primaryCategory: 'public-interest',
      secondaryCategory: '一般社団・財団法人'
    };
  }

  // 公益社団・財団法人
  if (/公益社団法人|公益財団法人/.test(name)) {
    return {
      primaryCategory: 'public-interest',
      secondaryCategory: '公益社団・財団法人'
    };
  }

  // 株式会社
  if (/株式会社/.test(name)) {
    return {
      primaryCategory: 'private',
      secondaryCategory: '株式会社'
    };
  }

  // 有限会社
  if (/有限会社/.test(name)) {
    return {
      primaryCategory: 'private',
      secondaryCategory: '有限会社'
    };
  }

  // 合同会社
  if (/合同会社/.test(name)) {
    return {
      primaryCategory: 'private',
      secondaryCategory: '合同会社'
    };
  }

  // 合資会社
  if (/合資会社/.test(name)) {
    return {
      primaryCategory: 'private',
      secondaryCategory: '合資会社'
    };
  }

  // ========================================
  // 優先度3: 名前末尾パターン
  // ========================================

  // 都道府県
  if (/[都道府県]$/.test(name)) {
    return {
      primaryCategory: 'government',
      secondaryCategory: '都道府県'
    };
  }

  // 市区町村
  if (/[市区町村]$/.test(name)) {
    return {
      primaryCategory: 'government',
      secondaryCategory: '市区町村'
    };
  }

  // 大学
  if (/大学$/.test(name)) {
    return {
      primaryCategory: 'public-interest',
      secondaryCategory: '大学'
    };
  }

  // 組合
  if (/組合$/.test(name)) {
    return {
      primaryCategory: 'public-interest',
      secondaryCategory: '組合'
    };
  }

  // 機構・事業団・基金
  if (/機構$|事業団$|基金$/.test(name)) {
    return {
      primaryCategory: 'public-interest',
      secondaryCategory: '特殊法人・機構'
    };
  }

  // 協会
  if (/協会$/.test(name)) {
    return {
      primaryCategory: 'public-interest',
      secondaryCategory: '協会'
    };
  }

  // ========================================
  // 優先度4: corporateTypeによる判定（名前で判定できなかった場合）
  // ========================================

  switch (corporateType) {
    case '101':
      return { primaryCategory: 'government', secondaryCategory: '国の機関' };
    case '201':
      return { primaryCategory: 'government', secondaryCategory: '都道府県' };
    case '301':
      return { primaryCategory: 'private', secondaryCategory: '株式会社' };
    case '302':
      return { primaryCategory: 'private', secondaryCategory: '有限会社' };
    case '304':
      return { primaryCategory: 'private', secondaryCategory: '合資会社' };
    case '305':
      return { primaryCategory: 'private', secondaryCategory: '合同会社' };
    case '399':
      return { primaryCategory: 'public-interest', secondaryCategory: '公益法人等' };
    case '401':
      return { primaryCategory: 'private', secondaryCategory: '外国法人' };
    case '499':
      return { primaryCategory: 'public-interest', secondaryCategory: 'その他法人' };
    default:
      return { primaryCategory: 'individual-other', secondaryCategory: '個人・その他' };
  }
}
```

### 2.2 【高】テスト戦略の欠如

**問題**: タグ判定ロジックの正確性を検証する方法が定義されていない。

**修正案**: テストケースとバリデーションスクリプトを追加。

```typescript
// scripts/validate-tags.ts

interface TagValidationCase {
  name: string;
  corporateType: string;
  expectedPrimary: PrimaryCategory;
  expectedSecondary: string;
}

const VALIDATION_CASES: TagValidationCase[] = [
  // 行政組織
  { name: '関東地方整備局', corporateType: '301', expectedPrimary: 'government', expectedSecondary: '地方整備局等' },
  { name: '九州農政局', corporateType: '301', expectedPrimary: 'government', expectedSecondary: '地方整備局等' },
  { name: '東京労働局', corporateType: '', expectedPrimary: 'government', expectedSecondary: '労働局' },
  { name: '沖縄防衛局', corporateType: '101', expectedPrimary: 'government', expectedSecondary: '国の機関' },
  { name: '総務省', corporateType: '', expectedPrimary: 'government', expectedSecondary: '国の機関' },
  { name: '東京都', corporateType: '201', expectedPrimary: 'government', expectedSecondary: '都道府県' },
  { name: '横浜市', corporateType: '', expectedPrimary: 'government', expectedSecondary: '市区町村' },

  // 民間企業
  { name: '株式会社博報堂', corporateType: '', expectedPrimary: 'private', expectedSecondary: '株式会社' },
  { name: '富士通株式会社', corporateType: '301', expectedPrimary: 'private', expectedSecondary: '株式会社' },
  { name: 'PwCコンサルティング合同会社', corporateType: '305', expectedPrimary: 'private', expectedSecondary: '合同会社' },

  // 公益法人
  { name: '国立研究開発法人産業技術総合研究所', corporateType: '399', expectedPrimary: 'public-interest', expectedSecondary: '国立研究開発法人' },
  { name: '独立行政法人日本学術振興会', corporateType: '399', expectedPrimary: 'public-interest', expectedSecondary: '独立行政法人' },
  { name: '一般社団法人全国石油協会', corporateType: '', expectedPrimary: 'public-interest', expectedSecondary: '一般社団・財団法人' },
  { name: '全国健康保険協会', corporateType: '399', expectedPrimary: 'public-interest', expectedSecondary: '協会' },

  // 特殊ケース
  { name: '米空軍省', corporateType: '', expectedPrimary: 'government', expectedSecondary: '国の機関' }, // 外国政府
  { name: '年金受給者', corporateType: '', expectedPrimary: 'individual-other', expectedSecondary: '個人・その他' },
];

export function validateTagClassification(): { passed: number; failed: TagValidationCase[] } {
  const failed: TagValidationCase[] = [];

  for (const testCase of VALIDATION_CASES) {
    const result = detectOrganizationType(testCase.name, testCase.corporateType);
    if (result.primaryCategory !== testCase.expectedPrimary ||
        result.secondaryCategory !== testCase.expectedSecondary) {
      failed.push(testCase);
      console.error(`FAIL: ${testCase.name}`);
      console.error(`  Expected: ${testCase.expectedPrimary}/${testCase.expectedSecondary}`);
      console.error(`  Got: ${result.primaryCategory}/${result.secondaryCategory}`);
    }
  }

  return { passed: VALIDATION_CASES.length - failed.length, failed };
}
```

**追加**: `package.json`にバリデーションコマンドを追加。

```json
{
  "scripts": {
    "validate-tags": "npx tsx scripts/validate-tags.ts"
  }
}
```

### 2.3 【中】業種タグの優先度問題

**問題**: 複数の業種タグが付与された場合の表示優先度が不明確。

**現状の問題例**:
```json
{
  "spendingName": "株式会社博報堂",
  "industryTags": ["事務局・BPR", "印刷・広告"]  // どちらが主要？
}
```

**修正案**: `primaryIndustryTag`フィールドを追加し、主要な業種を明示。

```typescript
export interface SpendingTags {
  primaryCategory: PrimaryCategory;
  secondaryCategory: string;

  /** 主要業種（UIのバッジ表示用） */
  primaryIndustryTag: IndustryTag;

  /** 全業種タグ（詳細表示用） */
  industryTags: IndustryTag[];

  lockInRisk?: LockInRisk;
  lockInRiskReason?: string;
}
```

**判定ロジック**: 金額ベースで最も大きい事業の業種を主要タグとする。または、以下の優先順位で決定：

```typescript
const INDUSTRY_PRIORITY: IndustryTag[] = [
  '防衛・装備',        // 1. 安全保障は最優先
  'ITシステム・保守',  // 2. IT関連
  '事務局・BPR',      // 3. 事務局モデル
  'コンサルティング', // 4. コンサル
  '建設・土木',       // 5. 公共事業
  '医療・保険',       // 6. 社会保障
  '教育・研究',       // 7. 教育
  'エネルギー',       // 8. エネルギー
  '印刷・広告',       // 9. 印刷・広告
  '金融',             // 10. 金融
  '物流・運輸',       // 11. 物流
  '農林水産',         // 12. 農林水産
  '製造',             // 13. 製造
  'その他'            // 14. その他
];

function determinePrimaryIndustry(tags: IndustryTag[]): IndustryTag {
  for (const priority of INDUSTRY_PRIORITY) {
    if (tags.includes(priority)) {
      return priority;
    }
  }
  return 'その他';
}
```

### 2.4 【中】パフォーマンス最適化

**問題**: 12,869件の支出先に対して毎回正規表現を評価するのは非効率。

**修正案**: 正規表現を事前コンパイルし、定数として保持。

```typescript
// scripts/tag-classifier.ts

// 事前コンパイルされた正規表現
const PATTERNS = {
  // 行政組織
  REGIONAL_BUREAU: /地方整備局$|農政局$|森林管理局$|経済産業局$|財務局$/,
  LABOR_BUREAU: /労働局$/,
  DEFENSE_BUREAU: /防衛局$/,
  MINISTRY: /省$/,
  PREFECTURE: /[都道府県]$/,
  MUNICIPALITY: /[市区町村]$/,

  // 法人格
  NRDO: /国立研究開発法人/,
  IAA: /独立行政法人/,
  GENERAL_CORP: /一般社団法人|一般財団法人/,
  PUBLIC_CORP: /公益社団法人|公益財団法人/,
  KABUSHIKI: /株式会社/,
  YUGEN: /有限会社/,
  GODO: /合同会社/,
  GOSHI: /合資会社/,

  // 公益法人
  UNIVERSITY: /大学$/,
  COOPERATIVE: /組合$/,
  SPECIAL_CORP: /機構$|事業団$|基金$/,
  ASSOCIATION: /協会$/,

  // 法人格を含まない除外パターン
  COMPANY_SUFFIXES: /(株式会社|有限会社|合同会社)/,

  // 業種判定
  IT_SYSTEM: /システム|保守|運用|クラウド|ネットワーク|ソフトウェア|ICT/,
  DEFENSE: /防衛|装備|誘導弾|艦艇|航空機|自衛隊/,
  CONSTRUCTION: /建設|土木|整備局|工事|ゼネコン/,
  CONSULTING: /コンサル|アクセンチュア|デロイト|PwC|McKinsey|野村総合研究所/,
  SECRETARIAT: /事務局|協議会|推進|支援事業/,
  EDUCATION: /大学|研究|学術|科学/,
  MEDICAL: /医療|保険|健康|病院|製薬/,
  ENERGY: /エネルギー|石油|ガス|電力/,
  PRINTING: /印刷|広告|博報堂|電通/,
  AGRICULTURE: /農業|農政|林業|森林|水産/,
} as const;

// パターンマッチング関数（高速化）
function matchPattern(name: string, pattern: RegExp): boolean {
  return pattern.test(name);
}
```

### 2.5 【低】外国法人・英語名の判定

**問題**: 英語名の企業（AWS、McKinsey等）の判定が不十分。

**現状**:
```typescript
if (corporateType === '401') {
  return { primaryCategory: 'private', secondaryCategory: '外国法人' };
}
```

**問題点**: corporateTypeが未設定の場合、「Amazon Web Services」等が「個人・その他」に分類される可能性。

**修正案**: 英語名パターンを追加。

```typescript
// 外国法人の判定（corporateType確認前に名前でも判定）
const FOREIGN_COMPANY_PATTERNS = /^(Amazon|Google|Microsoft|Apple|Oracle|IBM|SAP|Accenture|McKinsey|Boston Consulting|Bain|AWS|Meta|OpenAI)/i;

if (FOREIGN_COMPANY_PATTERNS.test(name) || corporateType === '401') {
  return {
    primaryCategory: 'private',
    secondaryCategory: '外国法人'
  };
}
```

---

## 3. アーキテクチャ上の考慮事項

### 3.1 タグ付けのタイミング

**提案書の設計**: `generate-structured-json.ts`でタグ付けを実行（ビルド時）

**長所**:
- ランタイムのパフォーマンスに影響しない
- JSONに事前計算済みのタグが含まれる

**短所**:
- タグロジック変更時にデータ再生成が必要
- JSONサイズが増加（推定+2MB）

**推奨**: 現在の設計（ビルド時タグ付け）を維持。ただし、リスク評価（lockInRisk）は別途計算スクリプトで追加する方が柔軟。

### 3.2 データ構造の拡張性

**懸念**: `SpendingTags`を`SpendingRecord`に直接追加すると、将来的に肥大化する可能性。

**代替案**: 別ファイルでタグ情報を管理（optional）

```
public/data/
├── rs2024-structured.json      # 基本データ（変更なし）
├── rs2024-structured.json.gz   # 圧縮版
└── rs2024-tags.json            # タグ情報（spendingId → tags）
```

**長所**:
- 基本データとタグデータを分離して管理可能
- タグのみの更新が容易

**短所**:
- クライアント側でマージが必要
- 複雑性が増加

**推奨**: 当面は提案書の設計（SpendingRecordに直接追加）で進め、将来的に分離を検討。

### 3.3 UIへの影響

**サンキー図ノード**: 現在の`SankeyNode.details`に`tags`を追加する必要がある。

```typescript
// types/preset.ts
export interface SankeyNodeDetails {
  // 既存フィールド...

  /** タグ情報（recipient/subcontractノードのみ） */
  tags?: SpendingTags;
}
```

**sankey-generator.ts**: recipientノード生成時にタグを含める。

```typescript
// app/lib/sankey-generator.ts
const recipientNode: SankeyNode = {
  id: `recipient-${spendingId}`,
  name: spendingName,
  type: 'recipient',
  value: amount,
  details: {
    corporateNumber,
    location,
    projectCount,
    tags: spending.tags  // 追加
  }
};
```

---

## 4. 実装優先度の調整提案

### 4.1 修正後の優先度

| Phase | 内容 | 提案書の工数 | 修正後の工数 | 備考 |
|:------|:-----|:------------|:------------|:-----|
| Phase 0 | テストケース作成 | - | 1時間 | **新規追加** |
| Phase 1 | 基本タグ付けとデータ生成 | 4時間 | 5時間 | パターン順序修正 |
| Phase 1.5 | タグバリデーション | - | 1時間 | **新規追加** |
| Phase 2 | UI表示 | 3時間 | 3時間 | 変更なし |
| Phase 3 | フィルタリング機能 | 5時間 | 5時間 | 変更なし |
| Phase 4 | リスク評価自動化 | 8時間 | 10時間 | 業種優先度追加 |

### 4.2 実装順序

1. **Phase 0: テストケース作成** (1時間)
   - 主要パターンのテストケースを定義
   - バリデーションスクリプトを作成

2. **Phase 1: 基本タグ付け** (5時間)
   - パターン判定順序を修正した`tag-classifier.ts`を作成
   - `generate-structured-json.ts`に統合
   - データ再生成

3. **Phase 1.5: バリデーション** (1時間)
   - テストケースの実行
   - 誤判定の修正

4. **Phase 2〜4**: 提案書通り

---

## 5. 追加検討事項

### 5.1 マスタデータの整備

**問題**: 名前パターンでは対応できない特殊ケースが存在する可能性。

**提案**: 手動ラベリング用のマスタファイルを用意。

```typescript
// data/manual-tags.json
{
  "overrides": {
    "NEDO": {
      "primaryCategory": "public-interest",
      "secondaryCategory": "国立研究開発法人",
      "industryTags": ["教育・研究"]
    },
    "年金受給者": {
      "primaryCategory": "individual-other",
      "secondaryCategory": "個人",
      "industryTags": ["その他"]
    }
  }
}
```

### 5.2 ログ・監査

**提案**: タグ付け処理時に判定根拠をログ出力。

```typescript
function classifySpendingWithLog(spending: SpendingRecord): SpendingTags {
  const result = classifySpending(spending);

  console.log(`[TAG] ${spending.spendingName}: ${result.primaryCategory}/${result.secondaryCategory} <- ` +
    `corporateType=${spending.corporateType}, matched=${getMatchedPattern(spending.spendingName)}`);

  return result;
}
```

これにより、誤判定の原因追跡が容易になる。

### 5.3 将来的な機械学習導入

現在のルールベースでカバーできない場合、以下のアプローチを検討：

1. **教師あり学習**: 手動ラベリングデータを蓄積し、テキスト分類モデルを訓練
2. **類似度ベース**: 既知の企業名との類似度で業種を推定
3. **外部データ連携**: 法人番号データベースとの連携（国税庁API）

---

## 6. 結論

### 6.1 総合評価

提案書は**実装可能な品質**であり、基本設計は堅実です。ただし、以下の修正を適用することで、より堅牢な実装となります。

### 6.2 必須修正（Sonnet実装時に適用）

1. **名前パターン判定の順序修正**: 名前パターンを優先し、corporateTypeは補助的に使用
2. **テストケースの追加**: Phase 0としてテストケースを作成
3. **正規表現の事前コンパイル**: パフォーマンス最適化

### 6.3 推奨修正（時間があれば）

1. **primaryIndustryTagの追加**: 主要業種の明示
2. **外国法人パターンの追加**: 英語名企業の対応

### 6.4 Sonnet実装への申し送り事項

```markdown
## Sonnet実装時の注意点

1. **パターン判定順序**: 名前パターン → corporateTypeの順で評価すること
2. **テスト駆動**: 先にテストケースを作成し、判定ロジックを検証すること
3. **正規表現**: 事前コンパイルで高速化すること
4. **ログ出力**: 開発時は判定根拠をログ出力し、誤判定を追跡可能にすること
5. **段階的実装**: Phase 0 → 1 → 1.5 → 2 の順で進め、各Phaseで動作確認すること
```

---

**レビュアー**: Claude Opus 4.5
**レビュー完了日時**: 2026年1月31日 12:30
