# 支出集計の重複問題と修正方針

## 1. 問題の概要

現在のrs2024-structured.jsonの支出集計に**約25.3兆円の重複**が含まれている。

| 項目 | 金額 | 備考 |
|------|------|------|
| 現在の総支出額 | 155.03兆円 | 重複含む（誤り） |
| 正しい総支出額 | 129.63兆円 | 直接支出のみ |
| 重複金額 | 25.30兆円 | 間接支出（再委託・間接補助金） |
| 重複率 | 16.3% | - |

---

## 2. 重複の原因

### 2.1 データ構造

- **5-1_RS_2024_支出先_支出情報.csv**: 全ての支出ブロック（A, B, C...）の金額を含む
- **5-2_RS_2024_支出先_支出ブロックのつながり.csv**: 支出ブロック間の資金フローを記録
  - `担当組織からの支出=TRUE`: 政府からの直接支出
  - `担当組織からの支出=FALSE`: 再委託・間接補助金（他の支出先経由）

### 2.2 現在の集計ロジック（問題あり）

`scripts/generate-structured-json.ts` が 5-1 CSV の全ブロックを単純合計している。

```
A（博報堂 2.37兆円） + B（電力会社 1.90兆円） + C（ガス会社 0.43兆円） + ...
= 5.04兆円（重複含む）
```

### 2.3 正しい集計ロジック

5-2 CSV の`担当組織からの支出=TRUE`のブロックのみを合計すべき。

```
A（博報堂 2.37兆円） + H（直接補助 0.31兆円） + I（デロイトトーマツ 0円）
= 2.68兆円（正しい値）
```

---

## 3. 具体例：プロジェクト7259（電気・ガス価格激変緩和対策等事業）

### 3.1 資金フロー構造

```
経済産業省
    │
    ├───[補助金]──→ A. 博報堂（2.37兆円）───→ B. 電力会社（1.90兆円）
    │                    │                    └─ 間接補助金
    │                    │
    │                    ├───→ C. ガス会社（0.43兆円）
    │                    │      └─ 間接補助金
    │                    │
    │                    ├───→ D. 三井住友銀行（27億円）
    │                    │      └─ 委託
    │                    │
    │                    └───→ E. 博報堂プロダクツ（125億円）
    │                           └─ 委託
    │                                 │
    │                                 └───→ F. ヴァリアス（120億円）
    │                                          └─ 再委託
    │                                                │
    │                                                └───→ G. デジタルシティ（8.7億円）
    │                                                         └─ 再々委託
    │
    ├───[補助金]──→ H. 東京電力EP等（0.31兆円）
    │                    └─ 大手電力への直接補助
    │
    └───[委託]───→ I. デロイトトーマツ（0円）
                         └─ 制度設計業務
```

### 3.2 集計の比較

| 集計方法 | 金額 | 問題 |
|----------|------|------|
| 全ブロック合計 | 5.04兆円 | B〜Gが二重カウント |
| 直接支出のみ（A+H+I） | 2.68兆円 | 正しい |
| 重複分（B〜G） | 2.36兆円 | Aに含まれる金額 |

---

## 4. 修正が必要なファイル

### 4.1 必須修正

| ファイル | 変更内容 | 優先度 |
|----------|----------|--------|
| [scripts/generate-structured-json.ts](scripts/generate-structured-json.ts) | 5-2 CSVを読み込み、間接支出ブロックを除外 | **高** |
| [types/structured.ts](types/structured.ts) | SpendingProjectに`isDirectSpending`フラグ追加（オプション） | 中 |

### 4.2 影響を受けるファイル

| ファイル | 影響 |
|----------|------|
| [app/lib/sankey-generator.ts](app/lib/sankey-generator.ts) | `totalSpendingAmount`の値が変わる |
| [app/sankey/page.tsx](app/sankey/page.tsx) | 表示される金額が変わる |
| [app/api/sankey/route.ts](app/api/sankey/route.ts) | APIレスポンスの金額が変わる |

---

## 5. 修正方針

### 方針A: 間接支出を完全除外（推奨）

```typescript
// generate-structured-json.ts
// 5-2 CSVから間接支出ブロックのセットを作成
const indirectBlocks = new Set<string>();
for (const row of fundFlowRows) {
  if (row['担当組織からの支出'] === 'FALSE') {
    const key = `${row['予算事業ID']}_${row['支出先の支出先ブロック']}`;
    indirectBlocks.add(key);
  }
}

// 5-1 CSVの処理で間接支出ブロックをスキップ
for (const row of spendingRows) {
  const key = `${row['予算事業ID']}_${row['支出先ブロック番号']}`;
  if (indirectBlocks.has(key)) continue;  // 間接支出はスキップ
  // ... 通常の処理
}
```

**メリット**:
- 正確な政府支出総額を表示
- 実装がシンプル

**デメリット**:
- 再委託先の詳細がサンキー図に表示されない

### 方針B: 間接支出を別フラグで管理

```typescript
// types/structured.ts
interface SpendingProject {
  // 既存フィールド...
  isDirectSpending: boolean;  // 政府からの直接支出か
  parentBlockNumber?: string; // 間接支出の場合、親ブロック番号
}
```

**メリット**:
- 再委託構造を保持しつつ、集計時に区別可能
- サンキー図で再委託フローを表示可能

**デメリット**:
- 実装が複雑
- サンキー図の表示ロジックも変更が必要

### 方針C: サンキー図を6列から7列に拡張

```
予算総計 → 府省庁 → 事業(予算) → 事業(支出) → 直接支出先 → 再委託先 → 費目
```

**メリット**:
- 再委託構造を完全に可視化

**デメリット**:
- 大規模な実装変更が必要
- 画面が複雑になる

---

## 6. 推奨実装計画

### Phase 1: データ修正（必須）

1. `generate-structured-json.ts` に 5-2 CSV 読み込み処理を追加
2. 間接支出ブロックの除外ロジックを実装
3. `npm run generate-structured` でJSONを再生成
4. 総支出額が129.63兆円になることを確認

### Phase 2: サンキー図更新（オプション）

1. 必要に応じて間接支出のフローを別途表示
2. ツールチップに再委託情報を追加

---

## 7. 検証方法

```bash
# JSONを再生成
npm run generate-structured

# 総支出額を確認
node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync('public/data/rs2024-structured.json')); console.log('総支出額:', (data.metadata.totalSpendingAmount/1e12).toFixed(2), '兆円')"

# 期待値: 約129.63兆円
```

---

## 8. 影響を受けるドキュメント

以下のドキュメントの金額も更新が必要：

| ドキュメント | 更新内容 |
|--------------|----------|
| [docs/20260130_1200_博報堂2.47兆円支出調査.md](docs/20260130_1200_博報堂2.47兆円支出調査.md) | 5.04兆円→2.68兆円 |
| CLAUDE.md | 総支出額の記載更新 |

---

## 参考データ

### 全データでの間接支出ブロック数

| 項目 | 件数 |
|------|------|
| 直接支出ブロック（TRUE） | 13,165 |
| 間接支出ブロック（FALSE） | 6,909 |
| ユニークな間接支出（プロジェクト+ブロック） | 6,577 |

### 主要な間接支出パターン

| パターン | 説明 | 金額規模 |
|----------|------|----------|
| 間接補助金 | 事務局経由で最終受益者へ | 約23兆円 |
| 再委託 | 受託者から下請けへ | 約2兆円 |
| 再々委託 | 2次下請け以降 | 約0.3兆円 |

---

## 作成日時

- 調査日: 2026-01-30 18:30
- 担当: Claude Opus 4.5
