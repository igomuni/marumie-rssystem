# TopN以外ノードの挙動仕様

## 概要

サンキー図において、TopN選択によって表示されない項目は「TopN以外」として集約されたノードとして表示される。このドキュメントでは、各ビューにおける「TopN以外」ノードの種類とクリック時の挙動を整理する。

**作成日**: 2025-12-03
**対象ファイル**:
- `app/sankey/page.tsx` (ノードクリックハンドラ)
- `app/lib/sankey-generator.ts` (ノード生成ロジック)

---

## 1. 全体ビュー (Global View)

### 1.1 府省庁(TopN以外)ノード

**ノードID**: `ministry-budget-other`
**表示名**: `府省庁(Top{N}以外)`
**列**: Column 1 (府省庁予算)
**ノードタイプ**: `ministry-budget`

#### 現在の挙動
- **クリック時**: offsetを増加させ、次のN件の府省庁を表示（ページネーション）
- **実装箇所**: `app/sankey/page.tsx:210-212`

```typescript
if (actualNode.id === 'ministry-budget-other') {
  setOffset(prev => prev + globalMinistryTopN);
  return;
}
```

#### 問題点
- クリック可能だが、ページネーション動作であることが分かりにくい
- 「次のページ」という意図が視覚的に伝わらない
- offsetが限界に達した場合の挙動が不明確

---

### 1.2 事業(TopN以外)ノード

**ノードID**: `project-budget-other-global`
**表示名**: `事業(Top{N}以外)`
**列**: Column 2 (事業予算)
**ノードタイプ**: `project-budget`

#### 現在の挙動
- **クリック時**: offsetを増加させる（府省庁のページネーション）
- **実装箇所**: `app/sankey/page.tsx:254-262`

```typescript
if (actualNode.name.match(/^事業\(Top\d+以外.*\)$/)) {
  if (viewMode === 'global') {
    setOffset(prev => prev + globalMinistryTopN);
  }
  return;
}
```

#### 問題点
- 事業ノードをクリックしているのに、府省庁のページネーションが動作する
- 「事業(TopN以外)」には複数の府省庁の事業が混在しているため、次に何が表示されるか不明確
- ユーザーは事業の詳細を見たい意図でクリックする可能性が高いが、その期待に応えていない

---

### 1.3 支出先(TopN以外)ノード

**ノードID**: `recipient-other-aggregated`
**表示名**: `支出先(Top{N}以外)`
**列**: Column 4 (支出先)
**ノードタイプ**: `recipient`

#### 現在の挙動
- **クリック時**: offsetを増加させる（府省庁のページネーション）
- **実装箇所**: `app/sankey/page.tsx:296-299`

```typescript
if (actualNode.name.match(/^支出先\(Top\d+以外\)$/)) {
  setOffset(prev => prev + globalMinistryTopN);
  return;
}
```

#### 問題点
- 支出先ノードをクリックしているのに、府省庁のページネーションが動作する
- 「支出先(TopN以外)」には複数の府省庁・事業からの支出先が混在している
- ユーザーは支出先の詳細を見たい可能性が高いが、府省庁ページが変わるだけ

---

### 1.4 「その他」ノード（受給者名が「その他」）

**ノードID**: `recipient-other-named`
**表示名**: `その他`
**列**: Column 4 (支出先)
**ノードタイプ**: `recipient`

#### 現在の挙動
- **クリック時**: 支出ビューに遷移し、「その他」という受給者の詳細を表示
- **実装箇所**: `app/sankey/page.tsx:289-293`

```typescript
if (actualNode.name === 'その他') {
  setViewMode('spending');
  setSelectedRecipient('その他');
  return;
}
```

#### 問題点
- 特になし（意図通りの動作）
- ただし、「支出先(TopN以外)」との違いが視覚的に分かりにくい可能性

---

## 2. 府省庁ビュー (Ministry View)

### 2.1 事業(TopN以外)ノード

**ノードID**: `project-budget-other-{ministryId}`
**表示名**: `事業(Top{N}以外)`
**列**: Column 2 (事業予算)
**ノードタイプ**: `project-budget`

#### 現在の挙動
- **クリック時**: projectOffsetを増加させ、次のN件の事業を表示（ページネーション）
- **実装箇所**: `app/sankey/page.tsx:254-262`

```typescript
if (actualNode.name.match(/^事業\(Top\d+以外.*\)$/)) {
  if (viewMode === 'ministry') {
    setProjectOffset(prev => prev + ministryProjectTopN);
  }
  return;
}
```

#### 問題点
- 全体ビューと同様、ページネーション動作であることが分かりにくい
- 「次のページ」という意図が視覚的に伝わらない
- projectOffsetが限界に達した場合の挙動が不明確

---

## 3. 事業ビュー (Project View)

### 3.1 支出先(TopN以外)ノード

**ノードID**: `recipient-other-aggregated`
**表示名**: `支出先(Top{N}以外)`
**列**: Column 4 (支出先)
**ノードタイプ**: `recipient`

#### 現在の挙動
- **クリック時**: offsetを増加させる（府省庁のページネーション）
- **実装箇所**: `app/sankey/page.tsx:296-299`

```typescript
if (actualNode.name.match(/^支出先\(Top\d+以外\)$/)) {
  setOffset(prev => prev + globalMinistryTopN);
  return;
}
```

#### 問題点
- 事業ビューで支出先ノードをクリックしているのに、府省庁のoffsetが増加する
- 事業ビューでは府省庁は1つに固定されているため、offsetを増加させても意味がない
- ユーザーは「この事業の他の支出先」を見たいと思う可能性が高いが、その期待に応えていない
- 例: 「中小企業生産性革命推進事業」は支出先が155件あり、支出先(Top20以外)をクリックすると次の20件の支出先を見たいはずだが、実際には府省庁のページが変わろうとする（効果なし）

---

## 4. 支出ビュー (Spending View)

### 4.1 府省庁(TopN以外)ノード

**ノードID**: `ministry-budget-other-spending-view`
**表示名**: `府省庁(Top{N}以外)`
**列**: Column 0 (府省庁予算)
**ノードタイプ**: `ministry-budget`

#### 現在の挙動
- **クリック時**: 特別な処理なし（通常のノードクリックハンドラに依存）
- **実装箇所**: 該当コードなし（デフォルト動作）

#### 問題点
- クリック時の挙動が定義されていない
- ユーザーは「府省庁(TopN以外)」の詳細を見たいと思う可能性があるが、何も起こらない

---

### 4.2 事業(TopN以外)ノード（TopN府省庁内）

**ノードID**: `project-budget-other-spending-view`
**表示名**: `事業(Top{N}以外)`
**列**: Column 1 (事業予算)
**ノードタイプ**: `project-budget`

#### 現在の挙動
- **クリック時**: projectOffsetを増加させる
- **実装箇所**: `app/sankey/page.tsx:254-262`

```typescript
if (actualNode.name.match(/^事業\(Top\d+以外.*\)$/)) {
  if (viewMode === 'spending') {
    setProjectOffset(prev => prev + spendingProjectTopN);
  }
  return;
}
```

#### 問題点
- 支出ビューでprojectOffsetを増加させているが、支出ビューではprojectOffsetは使用されていない可能性
- ページネーションの効果が不明確

---

### 4.3 事業(TopN以外府省庁)ノード

**ノードID**: `project-budget-other-ministry-spending-view`
**表示名**: `事業(Top{N}以外府省庁)`
**列**: Column 1 (事業予算)
**ノードタイプ**: `project-budget`

#### 現在の挙動
- **クリック時**: 正規表現にマッチし、projectOffsetを増加させる
- **実装箇所**: `app/sankey/page.tsx:254-262`

#### 問題点
- 「TopN以外府省庁」の事業をクリックしているのに、projectOffsetが増加するだけ
- どのような効果があるのか不明確

---

## 5. まとめ：問題点の整理

### 5.1 主要な問題

1. **意図が不明確**
   - 「TopN以外」ノードをクリックした際、何が起こるのかユーザーに伝わらない
   - ページネーション動作であることが視覚的に示されていない

2. **挙動の不一致**
   - 同じ名前のノード（例: `事業(TopN以外)`）でも、ビューによって動作が異なる
   - 全体ビューでは府省庁offsetが増加、府省庁ビューではprojectOffsetが増加

3. **列と動作の不一致**
   - 事業ノードをクリックしているのに府省庁のページネーションが動作（全体ビュー）
   - 支出先ノードをクリックしているのに府省庁のページネーションが動作（全体ビュー）

4. **未定義の動作**
   - 支出ビューの「府省庁(TopN以外)」など、クリック時の挙動が定義されていないノードが存在

5. **限界値の処理不足**
   - offsetが最大値に達した場合の処理が不明確
   - 「これ以上表示するデータがありません」といったフィードバックがない

### 5.2 ノード一覧表

| ビュー | ノード名 | 列 | 現在の挙動 | 問題点 |
|--------|----------|-----|------------|--------|
| 全体 | 府省庁(TopN以外) | Col 1 | 府省庁offset増加 | ページネーションと分かりにくい |
| 全体 | 事業(TopN以外) | Col 2 | 府省庁offset増加 | 事業ノードなのに府省庁offset |
| 全体 | 支出先(TopN以外) | Col 4 | 府省庁offset増加 | 支出先ノードなのに府省庁offset |
| 全体 | その他 | Col 4 | 支出ビューへ遷移 | ✓ 問題なし |
| 府省庁 | 事業(TopN以外) | Col 2 | projectOffset増加 | ページネーションと分かりにくい |
| 事業 | 支出先(TopN以外) | Col 4 | 府省庁offset増加 | 事業ビューなのに府省庁offset、効果なし |
| 支出 | 府省庁(TopN以外) | Col 0 | 未定義 | 動作が定義されていない |
| 支出 | 事業(TopN以外) | Col 1 | projectOffset増加 | 効果が不明確 |
| 支出 | 事業(TopN以外府省庁) | Col 1 | projectOffset増加 | 効果が不明確 |

---

## 6. 改善案の検討ポイント

### 6.1 UX改善の方向性

1. **視覚的な明確化**
   - 「TopN以外」ノードがページネーション可能であることを示すアイコンやラベル追加
   - 例: `府省庁(Top10以外) →` または `次の府省庁を表示 ›`

2. **一貫性のある動作**
   - 同じ列のノードは同じタイプの動作をする
   - 例: 事業ノードをクリックしたら、常に事業関連の動作（詳細表示や事業のページネーション）

3. **詳細モーダル表示**
   - 「TopN以外」ノードをクリックした際、一覧モーダルを開く
   - ユーザーが具体的な項目を選択できるようにする

4. **コンテキストメニュー**
   - 右クリックやホバーで複数の選択肢を提示
   - 「詳細を表示」「次のページを表示」など

5. **ツールチップの改善**
   - ホバー時に「クリックで次の10件を表示」などの説明を表示

### 6.2 技術的な実装オプション

#### オプション1: モーダル表示
- 「TopN以外」ノードクリック時、該当項目の一覧モーダルを表示
- メリット: ユーザーが具体的な項目を選択可能
- デメリット: モーダル実装の複雑さ、既に事業一覧・支出先一覧モーダルが存在

#### オプション2: ページネーション専用ノード
- 「次へ ›」などの明示的なページネーションノードを別途追加
- 「TopN以外」は非クリッカブルにし、情報表示のみ
- メリット: 意図が明確
- デメリット: サンキー図の複雑化

#### オプション3: サイドパネル表示
- 「TopN以外」ノードクリック時、サイドパネルに詳細リストを表示
- メリット: サンキー図と並行して情報を確認可能
- デメリット: UI実装の複雑さ

#### オプション4: 現在の動作を維持+UI改善
- 現在のページネーション動作を維持
- ノード名やツールチップでページネーションであることを明示
- メリット: 実装コストが低い
- デメリット: 根本的な問題は解決しない

---

## 7. データ構造の参照

### 関連する型定義

```typescript
// types/sankey.ts
interface SankeyNode {
  id: string;
  name: string;
  type: 'ministry-budget' | 'project-budget' | 'project-spending' | 'recipient' | 'other';
  value: number;
  originalId?: number;
  details?: {
    // ...
  };
}
```

### 関連するstate変数

```typescript
// app/sankey/page.tsx
const [offset, setOffset] = useState(0);                    // 全体ビューの府省庁ページネーション
const [projectOffset, setProjectOffset] = useState(0);      // 府省庁ビューの事業ページネーション
const [viewMode, setViewMode] = useState<'global' | 'ministry' | 'project' | 'spending'>('global');
```

---

## 8. 次のステップ

1. **要件定義**
   - どの改善案を採用するか決定
   - ユーザーの期待動作を明確化

2. **設計**
   - 選択した改善案の詳細設計
   - UI/UXのモックアップ作成

3. **実装**
   - `app/sankey/page.tsx` のノードクリックハンドラ修正
   - 必要に応じて新規コンポーネント作成
   - `app/lib/sankey-generator.ts` のノード生成ロジック調整

4. **テスト**
   - 各ビューでの動作確認
   - エッジケース（offset限界など）の確認

---

**ドキュメント終了**
