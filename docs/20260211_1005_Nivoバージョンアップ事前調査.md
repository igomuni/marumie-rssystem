# Nivo バージョンアップ事前調査

**調査日**: 2026年2月11日
**対象**: `@nivo/sankey` 0.87.0 → 0.99.0

---

## 1. 現状と目標

| 項目 | 現状 | 目標 |
|------|------|------|
| `@nivo/sankey` | `0.87.0` (installed) | `0.99.0` (latest) |
| バージョン差 | - | 12バージョン |
| React | `^18.3.1` | 変更なし |
| 使用ファイル | 3箇所（後述） | - |

---

## 2. 使用箇所

現在 `@nivo/sankey` を使用しているファイルは3箇所：

1. [app/sankey/page.tsx](../app/sankey/page.tsx) — メインRS予算サンキー図
2. [app/mof-budget-overview/page.tsx](../app/mof-budget-overview/page.tsx) — MOF予算全体ビュー
3. [app/mof-budget-overview/transfer-detail/page.tsx](../app/mof-budget-overview/transfer-detail/page.tsx) — 繰入詳細ビュー

いずれも `ResponsiveSankey` コンポーネントとカスタムレイヤー（`layers` prop）を使用。

---

## 3. バージョン別主要変更点（v0.87.0 → v0.99.0）

### v0.88.0
- `onClick` ハンドラの型がジェネリクスを正しく考慮するよう修正
- `onMouseDown`, `onMouseUp`, `onDoubleClick` イベントハンドラを追加

### v0.89.0 ⭐ 重要
- **カスタムレイヤーの正式サポート**: `layers` prop にカスタム関数を渡せる型定義が追加
  - `SankeyCustomLayer<N, L>` という union 型が追加
  - カスタム関数に `layerProps` が渡されるように
- `layers` prop が `readonly` 配列に変更
- ESM (Native ES Modules) サポート追加

### v0.90.0
- イベントハンドラ強化、型安全性改善

### v0.92.0
- `@nivo/theming` パッケージ追加（内部依存として追加）

### v0.93.0
- TypeScript 5.8.3 にアップグレード

### v0.96.0
- chart コンポーネントへの `ref` サポート追加

### v0.97.0
- `react-virtualized-auto-sizer` による ResponsiveSankey の改善

### v0.98.0
- **React 19 対応** (`@react-spring/web` を v10 対応に更新)
- peer deps: `react: ">= 16.14.0 < 19.0.0"` → `"^16.14 || ^17.0 || ^18.0 || ^19.0"`

### v0.99.0
- `@nivo/bar` 調整、依存パッケージの整理

---

## 4. 破壊的変更（Breaking Changes）

**影響度: 低**。主要な破壊的変更はなし。

ただし以下の点に注意：

| 変更点 | 詳細 | 対応要否 |
|--------|------|----------|
| `layers` prop の型が `readonly` 化 | 配列を `as const` にするか `readonly` 型で定義する必要がある可能性 | 要確認 |
| `@nivo/theming` が内部依存に追加 | npm で自動インストールされるため対応不要 | 不要 |
| React 19 対応の `react-spring` | v18 プロジェクトには影響なし | 不要 |

---

## 5. `@ts-expect-error` 解消の可能性

現在、カスタムレイヤー使用箇所3ヶ所すべてに以下のコメントがある：

```typescript
// @ts-expect-error - Nivoのカスタムレイヤー型定義が不完全なため
// eslint-disable-next-line @typescript-eslint/no-explicit-any
({ nodes }: any) => { ... }
```

**v0.89.0 でカスタムレイヤーの型定義が追加された**（`SankeyCustomLayer<N, L>` union型）ため、
アップグレード後は `@ts-expect-error` を削除できる可能性がある。

ただし、現在の実装は `layers` prop にカスタム関数を直接渡す形式であり、
型定義の修正状況はアップグレード後に実際にビルドして確認する必要がある。

---

## 6. アップグレード手順

```bash
# 1. feature ブランチ作成
git checkout -b feature/nivo-upgrade

# 2. パッケージ更新
npm install @nivo/sankey@0.99.0

# 3. ローカルビルド確認
npm run build

# 4. 型エラーがあれば修正
#    - layers prop の readonly 対応
#    - @ts-expect-error の削除試行

# 5. 動作確認
npm run dev
# → /sankey, /mof-budget-overview, /mof-budget-overview/transfer-detail を目視確認

# 6. PR作成
```

---

## 7. 確認ポイント

アップグレード後に以下を確認する：

- [ ] `npm run build` がエラーなく通る
- [ ] `/sankey` のサンキー図が正常に表示される（ノードラベル、リンク、ツールチップ）
- [ ] `/mof-budget-overview` のサンキー図が正常に表示される
- [ ] `/mof-budget-overview/transfer-detail` のサンキー図が正常に表示される
- [ ] カスタムレイヤー（ノード名・金額表示）が正常に動作する
- [ ] `@ts-expect-error` の削除を試みて型エラーがなければ削除する
- [ ] Vercel build が成功する

---

## 8. リスク評価

| リスク | 可能性 | 対策 |
|--------|--------|------|
| ビルドエラー（型エラー） | 低〜中 | 型定義確認、必要に応じて修正 |
| カスタムレイヤーの表示崩れ | 低 | 目視確認 |
| サンキー図のレイアウト変化 | 低 | 目視確認 |
| ResponsiveSankey の挙動変化 | 低 | react-virtualized-auto-sizer 変更の影響確認 |

**総合評価: アップグレード推奨**
破壊的変更はほぼなく、カスタムレイヤーの型改善・React 19 対応・TypeScript 5.8 対応などのメリットがある。
